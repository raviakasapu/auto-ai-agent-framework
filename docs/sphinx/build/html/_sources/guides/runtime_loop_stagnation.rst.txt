Runtime Loop & Stagnation
=========================

Overview
--------

The agent loop coordinates planning, tool execution, observation capture, and
termination. It includes safeguards for bounded execution and stagnation
detection.

Where to look in code
---------------------

- Agent loop: ``agent_framework/core/agent.py``
- Max iterations enforcement: ``agent_framework/core/agent.py``
- Stagnation detection: ``agent_framework/core/agent.py``
- Parallel execution helper: ``agent_framework/core/agent.py``

Max Iterations
--------------

- The planner can expose ``max_iterations`` (e.g., ``ReActPlanner``). The loop
  increments a counter per cycle and stops with a structured error message when
  ``iteration_count > max_iterations``.
- On stop, the agent writes a ``final`` memory entry, emits ``agent_end`` with a
  ``FinalResponse(operation="display_message")``, and returns the structured
  error payload.

Stagnation Detection
--------------------

- The loop tracks the last three planned action signatures in a fixed window.
- Signature definition: tuple of sorted ``(tool_name, str(tool_args))`` for all
  actions in the plan. This is order‑insensitive for parallel action sets.
- Trigger: if the 3‑entry window is full and each entry equals the current
  signature, the loop concludes it’s repeating without progress.
- Response: records an ``error`` memory entry, emits ``agent_end`` with a
  ``FinalResponse`` including ``{"stagnation": true}``, and returns it.

Parallel Execution
------------------

- When a planner returns a ``List[Action]``, the agent executes them in parallel
  via ``asyncio.gather``. It emits ``action_executed`` per tool.
- Validation: each tool call is validated against the tool’s Pydantic
  ``args_schema``; validation failures are collected and returned as a
  structured error ``FinalResponse``.

Structured Final Response
-------------------------

- The loop terminates immediately when a planner returns ``FinalResponse``.
- The agent emits ``agent_end`` with the full structured payload and returns the
  object itself. See :doc:`structured_final_response` for format and
  conventions.

Tuning Tips
-----------

- Adjust the stagnation window size (default 3) for earlier/later detection.
- Make the signature stricter/looser (e.g., normalize args or include a hash of
  observations) if needed for your domain.
- Configure planner ``max_iterations`` for your task complexity.
