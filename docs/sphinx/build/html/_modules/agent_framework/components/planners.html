

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agent_framework.components.planners &mdash; AI Agent Framework 2.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=b21de401"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            AI Agent Framework
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Domain Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../powerbi/index.html">Power BI Domain Example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Additional Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../framework_guide.html">Framework Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">AI Agent Framework (Overview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/library_architecture.html">Library Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/structured_final_response.html">Structured Final Response Pattern</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/runtime_loop_stagnation.html">Runtime Loop &amp; Stagnation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/observability.html">Observability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/message_store_integration.html">Implementation Guide: Message Store Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/message_store_format.html">Message Store Format Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/message_store_implementation.html">Message Store Implementation Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AI Agent Framework</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agent_framework.components.planners</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agent_framework.components.planners</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">,</span> <span class="n">BasePlanner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseInferenceGateway</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..models.script</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScriptPlan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..constants</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">SYNTHESIS</span><span class="p">,</span>
    <span class="n">USER_MESSAGE</span><span class="p">,</span>
    <span class="n">ASSISTANT_MESSAGE</span><span class="p">,</span>
    <span class="n">TASK</span><span class="p">,</span>
    <span class="n">ACTION</span><span class="p">,</span>
    <span class="n">FINAL</span><span class="p">,</span>
    <span class="n">OBSERVATION</span><span class="p">,</span>
    <span class="n">GLOBAL_OBSERVATION</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..policies.history_filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrchestratorHistoryFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..policies.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">HistoryFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>


<div class="viewcode-block" id="StaticPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.StaticPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StaticPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A deterministic planner for testing the framework mechanics.</span>

<span class="sd">    Rules (very simple):</span>

<span class="sd">    - If the task contains words like &#39;search&#39; or &#39;find&#39;, return an Action</span>
<span class="sd">      that targets the &#39;mock_search&#39; tool with the full task as query.</span>
<span class="sd">    - Otherwise, return a FinalResponse with a canned message.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">,</span> <span class="s2">&quot;find&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">keywords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">]</span>

<div class="viewcode-block" id="StaticPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.StaticPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="n">task_l</span> <span class="o">=</span> <span class="n">task_description</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">task_l</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="s2">&quot;mock_search&quot;</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">task_description</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No action needed. Task handled by planner.&quot;</span><span class="p">},</span>
            <span class="n">human_readable_summary</span><span class="o">=</span><span class="s2">&quot;No action needed. Task handled by planner.&quot;</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SingleActionPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.SingleActionPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SingleActionPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Always returns a single configured Action regardless of the task.</span>

<span class="sd">    Useful to drive a specific tool via YAML without LLM parsing.</span>
<span class="sd">    Sets the configured tool as a terminal tool so the Agent stops after one execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">terminal</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tool</span> <span class="o">=</span> <span class="n">tool_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">tool_args</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="c1"># Mark this tool as terminal so Agent.run converts its result into a FinalResponse and stops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">terminal</span> <span class="k">else</span> <span class="p">[]</span>

<div class="viewcode-block" id="SingleActionPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.SingleActionPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tool</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="LLMRouterPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.LLMRouterPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LLMRouterPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LLM-backed router that maps a natural-language task to a single tool call.</span>

<span class="sd">    Config:</span>
<span class="sd">      - inference_gateway: BaseInferenceGateway (resolved via registry/factory)</span>
<span class="sd">      - tool_specs: list of { tool: str, args: list[str] } describing allowed tools and their arg names</span>
<span class="sd">      - default_model_dir: optional fallback for model_dir when not provided by LLM</span>
<span class="sd">      - system_prompt: optional steering text</span>
<span class="sd">    Output JSON expected:</span>
<span class="sd">      {&quot;tool&quot;: &quot;add_relationship&quot;, &quot;args&quot;: {&quot;model_dir&quot;: &quot;/...&quot;, ...}}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inference_gateway</span><span class="p">:</span> <span class="n">BaseInferenceGateway</span><span class="p">,</span>
        <span class="n">tool_specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">default_model_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">inference_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_specs</span> <span class="o">=</span> <span class="n">tool_specs</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span> <span class="o">=</span> <span class="n">default_model_dir</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MODEL_DIR&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="s2">&quot;You are a router that returns a strict JSON object with fields &#39;tool&#39; and &#39;args&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="n">env_flag</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGENT_LOG_ROUTER_DETAILS&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_details</span> <span class="o">=</span> <span class="n">log_details</span> <span class="k">if</span> <span class="n">log_details</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">env_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

<div class="viewcode-block" id="LLMRouterPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.LLMRouterPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_prompt</span><span class="p">(</span><span class="n">task_description</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_details</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LLMRouterPlanner.prompt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LLMRouterPlanner.raw_response=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_parse_json</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="c1"># Fallback to heuristics</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heuristic_route</span><span class="p">(</span><span class="n">task_description</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">action</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_details</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LLMRouterPlanner.heuristic_action=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">action</span>
            <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unable to route request to a known tool.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="n">human_readable_summary</span><span class="o">=</span><span class="s2">&quot;Unable to route request to a known tool.&quot;</span>
            <span class="p">)</span>
        <span class="n">tool</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Ensure model_dir is present if needed</span>
        <span class="k">if</span> <span class="s2">&quot;model_dir&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_args</span><span class="p">(</span><span class="n">tool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_dir&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_details</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LLMRouterPlanner.parsed_action tool=</span><span class="si">%s</span><span class="s2"> args=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="n">tool</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_build_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">specs_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tool&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: args=</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_specs</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Allowed tools and their arguments:</span><span class="se">\n</span><span class="si">{</span><span class="n">specs_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Return ONLY JSON like </span><span class="se">{{\&quot;</span><span class="s2">tool</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">args</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">{{</span><span class="s2">...</span><span class="se">}}}}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;User task: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_try_parse_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="c1"># Extract first JSON object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{[\s\S]*\}&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_expected_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">tool</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_heuristic_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Action</span><span class="p">]:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Update by id</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(id|rel(ationship)?\s*id)\s*[:=\s]*([a-z0-9]+)&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;update&quot;</span> <span class="ow">in</span> <span class="n">t</span> <span class="ow">or</span> <span class="s2">&quot;deactivate&quot;</span> <span class="ow">in</span> <span class="n">t</span> <span class="ow">or</span> <span class="s2">&quot;activate&quot;</span> <span class="ow">in</span> <span class="n">t</span> <span class="ow">or</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">rel_id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span>
            <span class="k">if</span> <span class="n">rel_id</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_id</span>
            <span class="k">if</span> <span class="s2">&quot;deactivate&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s2">&quot;activate&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="s2">&quot;update_relationship&quot;</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># List tables</span>
        <span class="k">if</span> <span class="s2">&quot;list&quot;</span> <span class="ow">in</span> <span class="n">t</span> <span class="ow">and</span> <span class="s2">&quot;table&quot;</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span>
            <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="s2">&quot;list_tables&quot;</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># Add relationship: parse &#39;Table&#39;[Column] patterns</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;([^&#39;]+)&#39;\s*\[([^\]]+)\]&quot;</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">fc</span><span class="p">),</span> <span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">tc</span><span class="p">)</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;from_table&quot;</span><span class="p">:</span> <span class="n">ft</span><span class="p">,</span> <span class="s2">&quot;from_column&quot;</span><span class="p">:</span> <span class="n">fc</span><span class="p">,</span> <span class="s2">&quot;to_table&quot;</span><span class="p">:</span> <span class="n">tt</span><span class="p">,</span> <span class="s2">&quot;to_column&quot;</span><span class="p">:</span> <span class="n">tc</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_dir</span>
            <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="s2">&quot;add_relationship&quot;</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="StrategicPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.StrategicPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StrategicPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategic planning layer that creates execution plans and delegates with context.</span>
<span class="sd">    </span>
<span class="sd">    Unlike WorkerRouterPlanner which just classifies and routes, StrategicPlanner:</span>
<span class="sd">    1. Analyzes the task deeply</span>
<span class="sd">    2. Creates a multi-step execution plan</span>
<span class="sd">    3. Provides rich context to managers</span>
<span class="sd">    4. Tracks plan execution across delegations</span>
<span class="sd">    </span>
<span class="sd">    This enables true hierarchical intelligence where:</span>
<span class="sd">    - Director: Strategic thinking &amp; planning</span>
<span class="sd">    - Manager: Tactical execution &amp; synthesis</span>
<span class="sd">    - Worker: Operational execution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">inference_gateway</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">planning_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">history_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HistoryFilter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="o">=</span> <span class="n">worker_keys</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">inference_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planning_prompt</span> <span class="o">=</span> <span class="n">planning_prompt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_planning_prompt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_filter</span> <span class="o">=</span> <span class="n">history_filter</span> <span class="ow">or</span> <span class="n">OrchestratorHistoryFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_script_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ScriptPlan</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ScriptPlan</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ScriptPlan</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ScriptPlan</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ScriptPlan</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">response</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{[\s\S]*</span><span class="se">\&quot;</span><span class="s2">script</span><span class="se">\&quot;</span><span class="s2">[\s\S]*\}&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">json_text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ScriptPlan</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">json_text</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ManagerScriptPlanner: script validation error </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ve</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_planning_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;You are a strategic planner creating execution plans for complex tasks.</span>

<span class="s2">Your role:</span>
<span class="s2">1. Analyze the user&#39;s request deeply</span>
<span class="s2">2. Break it into concrete, sequential steps</span>
<span class="s2">3. Identify which workers/specialists are needed</span>
<span class="s2">4. Provide rich context for each step</span>

<span class="s2">Return JSON:</span>
<span class="s2">{</span>
<span class="s2">  &quot;plan&quot;: {</span>
<span class="s2">    &quot;steps&quot;: [</span>
<span class="s2">      {&quot;action&quot;: &quot;...&quot;, &quot;worker&quot;: &quot;...&quot;, &quot;context&quot;: &quot;...&quot;},</span>
<span class="s2">      ...</span>
<span class="s2">    ],</span>
<span class="s2">    &quot;rationale&quot;: &quot;Why this plan will succeed&quot;,</span>
<span class="s2">    &quot;primary_worker&quot;: &quot;worker_key&quot;</span>
<span class="s2">  }</span>
<span class="s2">}&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="StrategicPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.StrategicPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create strategic plan and delegate to primary worker with full context.&quot;&quot;&quot;</span>
        <span class="c1"># Build planning prompt with conversation history and optional director/data model context</span>
        <span class="n">workers_list</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">)</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_prompt</span><span class="p">}]</span>

        <span class="c1"># Inject contextual blocks if present (director_context and/or data_model_context)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span> <span class="k">as</span> <span class="n">_ctx</span>
            <span class="n">director_context</span> <span class="o">=</span> <span class="n">_ctx</span><span class="p">(</span><span class="s2">&quot;director_context&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_ctx</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">director_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span> <span class="k">as</span> <span class="n">_ctx2</span>
            <span class="n">data_model_context</span> <span class="o">=</span> <span class="n">_ctx2</span><span class="p">(</span><span class="s2">&quot;data_model_context&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">data_model_context</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">context_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">director_context</span><span class="p">:</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DIRECTOR CONTEXT:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">director_context</span><span class="p">)[:</span><span class="mi">4000</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_model_context</span><span class="p">:</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DATA MODEL CONTEXT:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data_model_context</span><span class="p">)[:</span><span class="mi">4000</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context_parts</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_parts</span><span class="p">)})</span>
        
        <span class="c1"># Filter history using hierarchical filter (orchestrator gets conversation summary only)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_os</span>
        <span class="n">include_conv</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">director_context</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">include_conv</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;STRATEGIC_INCLUDE_HISTORY_WITH_DIRECTOR&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">include_conv</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">include_conv</span><span class="p">:</span>
            <span class="c1"># Use history filter to get appropriate history for orchestrator role</span>
            <span class="n">filter_context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;orchestrator&quot;</span><span class="p">,</span> <span class="s2">&quot;max_conversation_turns&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
            <span class="n">filtered_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_filter</span><span class="o">.</span><span class="n">filter_for_prompt</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">filter_context</span><span class="p">)</span>
            
            <span class="c1"># Build messages from filtered conversation history only</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">filtered_history</span><span class="p">:</span>
                <span class="n">entry_type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">USER_MESSAGE</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)})</span>
                <span class="k">elif</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">ASSISTANT_MESSAGE</span><span class="p">:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)})</span>
        
        <span class="c1"># Add current task</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Task: </span><span class="si">{</span><span class="n">task_description</span><span class="si">}</span>
<span class="s2">Available workers: [</span><span class="si">{</span><span class="n">workers_list</span><span class="si">}</span><span class="s2">]</span>

<span class="s2">Create a strategic plan to accomplish this task.</span>
<span class="s2">Identify the primary worker and provide context for execution.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">})</span>
        
        <span class="c1"># Get strategic plan from LLM</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        
        <span class="c1"># Parse plan</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{[\s\S]*&quot;plan&quot;[\s\S]*\}&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">plan_data</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="p">{})</span>
                
                <span class="c1"># Extract parallel workers (optional) or fall back to primary worker</span>
                <span class="n">parallel_workers</span> <span class="o">=</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parallel_workers&quot;</span><span class="p">)</span>
                <span class="c1"># Also allow top-level parallel_workers for backward compatibility</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">parallel_workers</span><span class="p">:</span>
                    <span class="n">top_level_parallel</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parallel_workers&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">top_level_parallel</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">parallel_workers</span> <span class="o">=</span> <span class="n">top_level_parallel</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parallel_workers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># Filter to known workers and ensure uniqueness</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">parallel_workers</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">]</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">valid</span><span class="p">))</span>  <span class="c1"># de-dupe, preserve order</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Primary worker fallback</span>
                <span class="n">primary_worker</span> <span class="o">=</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;primary_worker&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="c1"># Heuristic override: route modification/validation of Power BI artifacts to powerbi-designer</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">task_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">task_description</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">wants_edit</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">task_type</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;modification&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">))</span>
                    <span class="c1"># Edit-intent verbs and BI artifact nouns</span>
                    <span class="n">edit_verbs</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;improve&quot;</span><span class="p">,</span> <span class="s2">&quot;optimiz&quot;</span><span class="p">,</span> <span class="s2">&quot;fix&quot;</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="s2">&quot;modify&quot;</span><span class="p">,</span> <span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="s2">&quot;create&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;rename&quot;</span><span class="p">,</span> <span class="s2">&quot;refactor&quot;</span><span class="p">,</span> <span class="s2">&quot;rewrite&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;repair&quot;</span><span class="p">,</span> <span class="s2">&quot;enhance&quot;</span><span class="p">,</span> <span class="s2">&quot;speed&quot;</span>
                    <span class="p">]</span>
                    <span class="n">bi_nouns</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;dax&quot;</span><span class="p">,</span> <span class="s2">&quot;measure&quot;</span><span class="p">,</span> <span class="s2">&quot;formula&quot;</span><span class="p">,</span> <span class="s2">&quot;relationship&quot;</span><span class="p">,</span> <span class="s2">&quot;relationships&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;column&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;partition&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;semantic model&quot;</span><span class="p">,</span> <span class="s2">&quot;calculated column&quot;</span><span class="p">,</span> <span class="s2">&quot;calculated table&quot;</span>
                    <span class="p">]</span>
                    <span class="n">inferred_edit</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">td</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">edit_verbs</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="n">td</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">bi_nouns</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">wants_edit</span> <span class="ow">or</span> <span class="n">inferred_edit</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;powerbi-designer&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">):</span>
                        <span class="n">primary_worker</span> <span class="o">=</span> <span class="s2">&quot;powerbi-designer&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                
                <span class="c1"># Log the strategic plan for visibility</span>
                <span class="c1"># Check both &quot;steps&quot; (legacy/default format) and &quot;phases&quot; (orchestrator format)</span>
                <span class="n">steps_or_phases</span> <span class="o">=</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;StrategicPlanner created plan: </span><span class="si">%d</span><span class="s2"> phases, primary_worker=</span><span class="si">%s</span><span class="s2">, rationale=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">steps_or_phases</span><span class="p">),</span>
                    <span class="n">primary_worker</span><span class="p">,</span>
                    <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rationale&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span>
                <span class="p">)</span>
                
                <span class="c1"># Return Actions: parallel (if requested) or single primary</span>
                <span class="k">if</span> <span class="n">valid</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
                        <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">Action</span><span class="p">(</span>
                                <span class="n">tool_name</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span>
                                <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span>
                                    <span class="s2">&quot;strategic_plan&quot;</span><span class="p">:</span> <span class="n">plan_data</span><span class="p">,</span>
                                    <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="n">task_description</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="n">actions</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Action</span><span class="p">(</span>
                        <span class="n">tool_name</span><span class="o">=</span><span class="n">primary_worker</span><span class="p">,</span>
                        <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;strategic_plan&quot;</span><span class="p">:</span> <span class="n">plan_data</span><span class="p">,</span>
                            <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="n">task_description</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse strategic plan: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, falling back to simple routing&quot;</span><span class="p">)</span>
        
        <span class="c1"># Fallback: simple routing</span>
        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{})</span></div>
</div>



<div class="viewcode-block" id="WorkerRouterPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.WorkerRouterPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WorkerRouterPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Orchestrator-level router that maps a natural-language task to a worker key.</span>

<span class="sd">    Behavior:</span>
<span class="sd">      - If explicit rules are provided, apply simple heuristic matching first.</span>
<span class="sd">      - Else, if an inference gateway is configured, ask the LLM to pick a worker from</span>
<span class="sd">        the provided list of worker_keys and return JSON: {&quot;worker&quot;: &quot;&lt;key&gt;&quot;, &quot;reason&quot;: &quot;...&quot;}.</span>
<span class="sd">      - If no decision can be made, return a FinalResponse with a graceful fallback message.</span>

<span class="sd">    Config:</span>
<span class="sd">      - worker_keys: list[str] valid worker identifiers (must match ManagerAgent workers)</span>
<span class="sd">      - rules: list[ { worker: str, include: [&quot;keyword&quot;...], exclude: [&quot;keyword&quot;...] } ]</span>
<span class="sd">      - inference_gateway: optional BaseInferenceGateway for LLM-based routing</span>
<span class="sd">      - default_worker: optional str used when LLM picks invalid or no match</span>
<span class="sd">      - system_prompt: optional str steering text for LLM classification</span>
<span class="sd">      - log_details: optional bool to emit DEBUG logs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">rules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inference_gateway</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseInferenceGateway</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">log_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="o">=</span> <span class="n">worker_keys</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">rules</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">inference_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="o">=</span> <span class="n">default_worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="s2">&quot;You are a strict classifier. Choose the best worker key for the task from the provided options and return only JSON {</span><span class="se">\&quot;</span><span class="s2">worker</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">&lt;key&gt;</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">reason</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;</span><span class="s2">}.&quot;</span>
        <span class="p">)</span>
        <span class="n">env_flag</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AGENT_LOG_ROUTER_DETAILS&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_details</span> <span class="o">=</span> <span class="n">log_details</span> <span class="k">if</span> <span class="n">log_details</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">env_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

        <span class="c1"># Optional env-based history controls for router prompts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_history</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AGENT_ROUTER_INCLUDE_HISTORY&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;AGENT_ROUTER_MAX_HISTORY_MESSAGES&quot;</span><span class="p">,</span> <span class="s2">&quot;20&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span> <span class="o">=</span> <span class="mi">20</span>

<div class="viewcode-block" id="WorkerRouterPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.WorkerRouterPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="c1"># 1) Apply heuristic rules first</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rules</span><span class="p">(</span><span class="n">task_description</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">worker</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_details</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WorkerRouterPlanner.rules_selected worker=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{})</span>

        <span class="c1"># 2) Ask LLM to pick a worker</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_prompt</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_details</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WorkerRouterPlanner.prompt=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;WorkerRouterPlanner.raw_response=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_worker</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">worker</span> <span class="ow">and</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{})</span>

        <span class="c1"># 3) Fallback: graceful final response from orchestrator</span>
        <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;I&#39;m not sure which capability should handle this. Could you clarify what you want to do?&quot;</span><span class="p">},</span>
            <span class="n">human_readable_summary</span><span class="o">=</span><span class="s2">&quot;I&#39;m not sure which capability should handle this. Could you clarify what you want to do?&quot;</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">include</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="p">[])]</span>
            <span class="n">exclude</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="p">[])]</span>
            <span class="k">if</span> <span class="n">include</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">include</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="ow">and</span> <span class="n">worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">return</span> <span class="n">worker</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">options</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">)</span>
        
        <span class="c1"># Include strategic plan/context if available to improve routing</span>
        <span class="n">strategic_plan</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
        <span class="n">director_context</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">plan_block</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                <span class="n">plan_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STRATEGIC PLAN (from orchestrator/manager):</span><span class="se">\n</span><span class="si">{</span><span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">800</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">plan_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STRATEGIC PLAN (from orchestrator/manager):</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">)[:</span><span class="mi">800</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">director_context</span><span class="p">:</span>
            <span class="n">plan_block</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DIRECTOR CONTEXT: </span><span class="si">{</span><span class="n">director_context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">plan_block</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="p">]</span>
        
        <span class="c1"># Add conversation history for context (optional, capped)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_history</span><span class="p">:</span>
            <span class="n">convo_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">USER_MESSAGE</span><span class="p">:</span>
                    <span class="n">convo_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)})</span>
                <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">ASSISTANT_MESSAGE</span><span class="p">:</span>
                    <span class="n">convo_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">convo_msgs</span> <span class="o">=</span> <span class="n">convo_msgs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span><span class="p">:]</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">convo_msgs</span><span class="p">)</span>
        
        <span class="c1"># Add current task</span>
        <span class="n">user_prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Available workers: [</span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;User task: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Which worker should handle this task? Return JSON: </span><span class="se">{{\&quot;</span><span class="s2">worker</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">&lt;worker_key&gt;</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">reason</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;}}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_prompt</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">messages</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{[\s\S]*\}&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="ChatPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ChatPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ChatPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Conversational planner that generates natural language responses using an LLM.</span>

<span class="sd">    This planner is designed for chat-style agents that don&#39;t use tools, but instead</span>
<span class="sd">    engage in conversation with the user. It builds a message history and asks the</span>
<span class="sd">    LLM to generate an assistant response.</span>

<span class="sd">    Config:</span>
<span class="sd">      - inference_gateway: BaseInferenceGateway (required)</span>
<span class="sd">      - system_prompt: optional str defining the assistant&#39;s persona</span>
<span class="sd">      - max_history_messages: optional int limiting context window (default: 20)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inference_gateway</span><span class="p">:</span> <span class="n">BaseInferenceGateway</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_history_messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">inference_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="ow">or</span> <span class="s2">&quot;You are a helpful AI assistant.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_history</span> <span class="o">=</span> <span class="n">max_history_messages</span> <span class="ow">or</span> <span class="mi">20</span>

<div class="viewcode-block" id="ChatPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ChatPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="c1"># Build message list from history</span>
        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">}]</span>
        
        <span class="c1"># Extract recent conversation turns from memory</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_history</span><span class="p">:]:</span>
            <span class="n">entry_type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Handle new conversation message types</span>
            <span class="k">if</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">USER_MESSAGE</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">ASSISTANT_MESSAGE</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
            <span class="c1"># Handle legacy message types for backward compatibility</span>
            <span class="k">elif</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">TASK</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">FINAL</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">})</span>
        
        <span class="c1"># Add current user message</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">task_description</span><span class="p">})</span>
        
        <span class="c1"># Get LLM response</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">},</span>
            <span class="n">human_readable_summary</span><span class="o">=</span><span class="n">response</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ReActPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ReActPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReActPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ReAct (Reasoning + Acting) planner for iterative tool use.</span>

<span class="sd">    Implements the ReAct pattern: Thought  Action  Observation loop.</span>
<span class="sd">    The planner reasons about the task, selects a tool, observes the result,</span>
<span class="sd">    and continues until the task is complete.</span>

<span class="sd">    Config:</span>
<span class="sd">      - inference_gateway: BaseInferenceGateway (required)</span>
<span class="sd">      - tool_descriptions: list[dict] with {name, description, args} for each tool</span>
<span class="sd">      - max_iterations: optional int limiting loop iterations (default: 5)</span>
<span class="sd">      - system_prompt: optional str defining reasoning style</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inference_gateway</span><span class="p">:</span> <span class="n">BaseInferenceGateway</span><span class="p">,</span>
        <span class="n">tool_descriptions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">max_iterations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">terminal_tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_llm_termination</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_function_calling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_parallel_tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">history_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HistoryFilter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">inference_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tool_descriptions</span> <span class="o">=</span> <span class="n">tool_descriptions</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># Optional: actual tool objects injected later by factory for introspection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iterations</span> <span class="o">=</span> <span class="n">max_iterations</span> <span class="ow">or</span> <span class="mi">15</span>  <span class="c1"># Increased default for parallel execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="s2">&quot;You are an AI agent using the ReAct pattern. &quot;</span>
            <span class="s2">&quot;Think step-by-step, choose actions (tools), observe results, and continue until complete. &quot;</span>
            <span class="s2">&quot;Return JSON: {</span><span class="se">\&quot;</span><span class="s2">thought</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">action</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">tool_name</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">args</span><span class="se">\&quot;</span><span class="s2">: {...}} or &quot;</span>
            <span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">thought</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">final_answer</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">...</span><span class="se">\&quot;</span><span class="s2">}.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_tools</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">terminal_tools</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_llm_termination</span> <span class="o">=</span> <span class="n">use_llm_termination</span> <span class="k">if</span> <span class="n">use_llm_termination</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_function_calling</span> <span class="o">=</span> <span class="n">use_function_calling</span> <span class="k">if</span> <span class="n">use_function_calling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="c1"># Limit parallel tool calls (function-calling mode)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_parallel_tool_calls</span>
        <span class="c1"># Store LLM&#39;s termination signal from most recent plan() call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_is_final_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Env-driven prompt controls (defaults preserve existing behavior)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_flag</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_int</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>

        <span class="c1"># Whether to include any prior history items (conversation turns)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_history</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">_flag</span><span class="p">(</span><span class="s2">&quot;AGENT_REACT_INCLUDE_HISTORY&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Whether to include execution traces (action/observation, global_observation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_traces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">_flag</span><span class="p">(</span><span class="s2">&quot;AGENT_REACT_INCLUDE_TRACES&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Whether to include global updates in prompts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_global_updates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">_flag</span><span class="p">(</span><span class="s2">&quot;AGENT_REACT_INCLUDE_GLOBAL_UPDATES&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Cap the number of history entries appended (None = unlimited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">_int</span><span class="p">(</span><span class="s2">&quot;AGENT_REACT_MAX_HISTORY_MESSAGES&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Truncate observation/global_observation payloads when rendering (applies to text + function-calling)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obs_truncate_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_int</span><span class="p">(</span><span class="s2">&quot;AGENT_REACT_OBS_TRUNCATE_LEN&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1000</span>
        <span class="c1"># History filter for hierarchical filtering (worker gets current turn only)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..policies.history_filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkerHistoryFilter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_filter</span> <span class="o">=</span> <span class="n">history_filter</span> <span class="ow">or</span> <span class="n">WorkerHistoryFilter</span><span class="p">()</span>

<div class="viewcode-block" id="ReActPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ReActPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="c1"># Note: max_iterations check moved to Agent.run() for accurate parallel action counting</span>
        <span class="c1"># The agent tracks actual iterations, not individual actions</span>
        
        <span class="c1"># Function calling mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_function_calling</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_with_function_calling</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
        
        <span class="c1"># Text-based mode (original)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_with_text_parsing</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_plan_with_text_parsing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Original text-based ReAct planning with JSON parsing.&quot;&quot;&quot;</span>
        <span class="c1"># Build ReAct prompt with history</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_react_prompt</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ReActPlanner.raw_response=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>
        
        <span class="c1"># Parse LLM response</span>
        <span class="c1"># First try to extract JSON from markdown if present</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_json_from_markdown</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">decision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_react_response</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        
        <span class="c1"># Handle JSON parsing errors with feedback to memory for next iteration</span>
        <span class="k">if</span> <span class="s2">&quot;_parse_error&quot;</span> <span class="ow">in</span> <span class="n">decision</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">decision</span><span class="p">[</span><span class="s2">&quot;_parse_error&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON parse error detected: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Add parse error hint to memory for next iteration</span>
            <span class="c1"># This creates a feedback loop: Agent  Error  Hint  Agent tries again</span>
            <span class="n">parse_error_hint</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot; JSON PARSE ERROR: Your previous response had malformed JSON: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;IMPORTANT: When using python_interpreter with complex code:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;1. Keep code simple and on fewer lines</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;2. Avoid nested quotes in JSON</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;3. Use simpler variable names</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;4. Or use final_answer to return results directly</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please try again with simpler formatting.&quot;</span>
            <span class="p">)</span>
            
            <span class="c1"># This will be picked up in the next iteration via memory/history</span>
            <span class="c1"># The agent loop will call plan() again with this hint in history</span>
            <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">parse_error_hint</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;parse_error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;hint&quot;</span><span class="p">:</span> <span class="s2">&quot;Retry with simpler code formatting&quot;</span>
                <span class="p">},</span>
                <span class="n">human_readable_summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;JSON parse error - need to retry with simpler formatting&quot;</span>
            <span class="p">)</span>
        
        <span class="c1"># Check for new structured final_response format</span>
        <span class="k">if</span> <span class="s2">&quot;final_response&quot;</span> <span class="ow">in</span> <span class="n">decision</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">final_resp_data</span> <span class="o">=</span> <span class="n">decision</span><span class="p">[</span><span class="s2">&quot;final_response&quot;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">=</span><span class="n">final_resp_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="s2">&quot;display_message&quot;</span><span class="p">),</span>
                    <span class="n">payload</span><span class="o">=</span><span class="n">final_resp_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="n">human_readable_summary</span><span class="o">=</span><span class="n">final_resp_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">,</span> <span class="s2">&quot;Task completed.&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse final_response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, falling back to legacy format&quot;</span><span class="p">)</span>
        
        <span class="c1"># Legacy support: simple final_answer string (or dict, convert if needed)</span>
        <span class="k">if</span> <span class="n">decision</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;final_answer&quot;</span><span class="p">):</span>
            <span class="n">final_answer</span> <span class="o">=</span> <span class="n">decision</span><span class="p">[</span><span class="s2">&quot;final_answer&quot;</span><span class="p">]</span>
            
            <span class="c1"># If final_answer is a dict/list, convert to readable string</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_answer</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                <span class="n">final_answer</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">final_answer</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_answer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">final_answer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">final_answer</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">final_answer</span><span class="p">},</span>
                <span class="n">human_readable_summary</span><span class="o">=</span><span class="n">final_answer</span>
            <span class="p">)</span>
        
        <span class="c1"># Capture LLM&#39;s termination signal (if provided)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_is_final_step</span> <span class="o">=</span> <span class="n">decision</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_final_step&quot;</span><span class="p">)</span>
        
        <span class="n">tool_name</span> <span class="o">=</span> <span class="n">decision</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>
        <span class="n">tool_args</span> <span class="o">=</span> <span class="n">decision</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Normalize args: support dicts and positional lists by mapping to expected arg names</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_args_for_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tool_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tool_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">mapped</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tool_args</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected</span><span class="p">):</span>
                    <span class="n">mapped</span><span class="p">[</span><span class="n">expected</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">tool_args</span> <span class="o">=</span> <span class="n">mapped</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">tool_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Provide/override MODEL_DIR when expected and value is missing, placeholder, or invalid</span>
        <span class="k">if</span> <span class="s2">&quot;model_dir&quot;</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">env_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MODEL_DIR&quot;</span><span class="p">)</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_dir&quot;</span><span class="p">)</span>
            <span class="n">placeholder_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;model_dir&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{model_dir}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{MODEL_DIR}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">needs_inject</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">md</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">md</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">placeholder_vals</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># If provided but not a directory, prefer env</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">needs_inject</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_os</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
                        <span class="n">needs_inject</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">needs_inject</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">needs_inject</span> <span class="ow">and</span> <span class="n">env_model_dir</span><span class="p">:</span>
                <span class="n">tool_args</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_model_dir</span>
        <span class="c1"># Coerce precision to int when provided as string</span>
        <span class="k">if</span> <span class="s2">&quot;precision&quot;</span> <span class="ow">in</span> <span class="n">expected</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tool_args</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tool_args</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">])</span> 
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">tool_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tool_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="n">tool_args</span><span class="p">)</span>
        
        <span class="c1"># Fallback if parsing fails</span>
        <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unable to determine next action.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="n">human_readable_summary</span><span class="o">=</span><span class="s2">&quot;Unable to determine next action.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_react_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Filter history using hierarchical filter (worker gets current turn only)</span>
        <span class="n">filter_context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">}</span>
        <span class="n">filtered_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_filter</span><span class="o">.</span><span class="n">filter_for_prompt</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">filter_context</span><span class="p">)</span>
        
        <span class="n">tools_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> (args: </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_descriptions</span>
        <span class="p">])</span>
        
        <span class="c1"># Inject strategic plan/context if available</span>
        <span class="n">strategic_plan</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
        <span class="n">director_context</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">plan_block</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                <span class="n">plan_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STRATEGIC PLAN (from orchestrator/manager):</span><span class="se">\n</span><span class="si">{</span><span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">plan_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STRATEGIC PLAN (from orchestrator/manager):</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">)[:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">director_context</span><span class="p">:</span>
            <span class="n">plan_block</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DIRECTOR CONTEXT: </span><span class="si">{</span><span class="n">director_context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># Build gated history string from filtered history</span>
        <span class="n">history_lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_history</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_traces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">filtered_history</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">USER_MESSAGE</span><span class="p">,</span> <span class="n">ASSISTANT_MESSAGE</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_history</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="s2">&quot;User&quot;</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">USER_MESSAGE</span> <span class="k">else</span> <span class="s2">&quot;Assistant&quot;</span>
                    <span class="n">history_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">ACTION</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_traces</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">history_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Action: </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tool&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">OBSERVATION</span><span class="p">,</span> <span class="n">GLOBAL_OBSERVATION</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_traces</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">GLOBAL_OBSERVATION</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_global_updates</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                            <span class="n">content</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">content_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_truncate_len</span><span class="p">:</span>
                        <span class="n">content_s</span> <span class="o">=</span> <span class="n">content_s</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_truncate_len</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;... (truncated)&quot;</span>
                    <span class="n">history_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Observation: </span><span class="si">{</span><span class="n">content_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Apply max history cap (keep tail)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">history_lines</span> <span class="o">=</span> <span class="n">history_lines</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span><span class="p">:]</span>

        <span class="n">history_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">history_lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">history_lines</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Add termination guidance if enabled</span>
        <span class="n">termination_guidance</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_llm_termination</span><span class="p">:</span>
            <span class="n">termination_guidance</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">IMPORTANT: Include &#39;is_final_step&#39; in your JSON response:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- Set &#39;is_final_step&#39;: true if this action will COMPLETE the user&#39;s request (e.g., pure informational queries like &#39;list tables&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- Set &#39;is_final_step&#39;: false if more steps are needed AFTER this action (e.g., verification before modification)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- Omit &#39;is_final_step&#39; only if uncertain (defaults to legacy terminal_tools behavior)&quot;</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plan_block</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available tools:</span><span class="se">\n</span><span class="si">{</span><span class="n">tools_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Task: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">history_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;What should I do next? (Return JSON with thought/action/args or thought/final_answer)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">termination_guidance</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_react_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{[\s\S]*\}&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No JSON found in response&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            
            <span class="n">json_str</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON parsing failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed JSON string: </span><span class="si">{</span><span class="n">text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="c1"># Return error indicator for recovery</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;_parse_error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;_raw_response&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_expected_args_for_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Prefer introspection of actual tool args schema when available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span> <span class="ow">and</span> <span class="n">tool_name</span> <span class="ow">and</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span><span class="p">:</span>
            <span class="n">tool_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">tool_obj</span><span class="o">.</span><span class="n">args_schema</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">((</span><span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_descriptions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">tool_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_json_from_markdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract JSON from markdown code blocks (```json...``` or ```...```).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span>
        
        <span class="c1"># Try to extract from ```json ... ``` blocks</span>
        <span class="n">json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;```(?:json)?\s*(\{[\s\S]*?\})\s*```&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Try to extract any JSON object from the text</span>
        <span class="n">json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{[\s\S]*\}&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Return as-is if no JSON found</span>
        <span class="k">return</span> <span class="n">text</span>

<div class="viewcode-block" id="ReActPlanner.should_terminate">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ReActPlanner.should_terminate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">should_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Optional termination hint for Agent: return True to stop after this action.</span>
<span class="sd">        </span>
<span class="sd">        Note: With the new final_response pattern, the planner returns FinalResponse directly</span>
<span class="sd">        when complete, so this method is rarely needed. It exists for legacy terminal_tools</span>
<span class="sd">        configuration and explicit LLM is_final_step signals.</span>
<span class="sd">        </span>
<span class="sd">        Priority order:</span>
<span class="sd">        1. LLM&#39;s explicit is_final_step signal (text-based mode with use_llm_termination=True)</span>
<span class="sd">        2. Fallback to terminal_tools list (legacy behavior)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Priority 1: Check if LLM explicitly signaled this is the final step (text-based mode)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_llm_termination</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_is_final_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">should_stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_is_final_step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;ReActPlanner.should_terminate: LLM signaled is_final_step=</span><span class="si">%s</span><span class="s2"> for tool=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">should_stop</span><span class="p">,</span> <span class="n">tool_name</span>
            <span class="p">)</span>
            <span class="c1"># Reset signal after use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_is_final_step</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">should_stop</span>
        
        <span class="c1"># Priority 2: Fallback to terminal_tools list (legacy behavior)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_tools</span> <span class="ow">or</span> <span class="p">[]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;ReActPlanner.should_terminate: tool=</span><span class="si">%s</span><span class="s2"> in terminal_tools, stopping&quot;</span><span class="p">,</span>
                    <span class="n">tool_name</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">return</span> <span class="kc">False</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_plan_with_function_calling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">FinalResponse</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function calling mode: use OpenAI tools API for structured tool selection.</span>
<span class="sd">        </span>
<span class="sd">        Supports parallel execution when LLM returns multiple tool_calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build conversation messages</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_function_calling_messages</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
        
        <span class="c1"># Build OpenAI tools schema</span>
        <span class="n">tools_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_tools_schema</span><span class="p">()</span>
        
        <span class="c1"># Call LLM with tools</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools_schema</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ReActPlanner.function_calling_response=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        
        <span class="c1"># Handle response</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Check for tool calls</span>
            <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tool_calls</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Log ALL tool calls from LLM (before truncation)</span>
                <span class="n">tool_names_requested</span> <span class="o">=</span> <span class="p">[</span><span class="n">tc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;ReActPlanner: LLM requested </span><span class="si">%d</span><span class="s2"> tool calls: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">),</span>
                    <span class="n">tool_names_requested</span>
                <span class="p">)</span>
                
                <span class="c1"># Convert ALL tool calls to Actions (enables parallel execution!)</span>
                <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                    <span class="n">args_str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tool_args</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">args_str</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">tool_args</span> <span class="o">=</span> <span class="p">{}</span>
                    
                    <span class="c1"># Apply model_dir injection if needed</span>
                    <span class="n">tool_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inject_model_dir</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_args</span><span class="p">)</span>
                    
                    <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="n">tool_args</span><span class="p">))</span>
                
                <span class="c1"># Optionally limit number of tool calls (e.g., force single-step)</span>
                <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">original_count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;ReActPlanner: LLM requested </span><span class="si">%d</span><span class="s2"> tool calls but max_parallel_tool_calls=</span><span class="si">%d</span><span class="s2">. &quot;</span>
                            <span class="s2">&quot;Truncating to first </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> (dropped: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                            <span class="n">original_count</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">,</span>
                            <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">tool_name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">]],</span>
                            <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">tool_name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">:]]</span>
                        <span class="p">)</span>
                    <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_parallel_tool_calls</span><span class="p">]</span>

                <span class="c1"># Return single action or list based on count</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Single action (backward compatible)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;ReActPlanner: Executing </span><span class="si">%d</span><span class="s2"> parallel tool calls: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">),</span>
                        <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">tool_name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">actions</span>  <span class="c1"># Parallel execution!</span>
            
            <span class="c1"># No tool calls, check for content (final answer)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                <span class="c1"># Try to parse as structured final_response if it&#39;s JSON</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Extract JSON from markdown code blocks if present</span>
                    <span class="n">json_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_json_from_markdown</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">content_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;final_response&quot;</span> <span class="ow">in</span> <span class="n">content_data</span><span class="p">:</span>
                        <span class="n">final_resp</span> <span class="o">=</span> <span class="n">content_data</span><span class="p">[</span><span class="s2">&quot;final_response&quot;</span><span class="p">]</span>
                        <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
                            <span class="n">operation</span><span class="o">=</span><span class="n">final_resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="s2">&quot;display_message&quot;</span><span class="p">),</span>
                            <span class="n">payload</span><span class="o">=</span><span class="n">final_resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                            <span class="n">human_readable_summary</span><span class="o">=</span><span class="n">final_resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">,</span> <span class="s2">&quot;Task completed.&quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse content as final_response JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Legacy: simple text response</span>
                <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
                    <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">},</span>
                    <span class="n">human_readable_summary</span><span class="o">=</span><span class="n">content</span>
                <span class="p">)</span>
        
        <span class="c1"># Fallback</span>
        <span class="k">return</span> <span class="n">FinalResponse</span><span class="p">(</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unable to determine next action.&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="n">human_readable_summary</span><span class="o">=</span><span class="s2">&quot;Unable to determine next action.&quot;</span>
        <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_function_calling_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build message list for function calling mode.&quot;&quot;&quot;</span>
        <span class="c1"># Filter history using hierarchical filter (worker gets current turn only)</span>
        <span class="n">filter_context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;worker&quot;</span><span class="p">}</span>
        <span class="n">filtered_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_filter</span><span class="o">.</span><span class="n">filter_for_prompt</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">filter_context</span><span class="p">)</span>
        
        <span class="c1"># Inject strategic plan/context if available</span>
        <span class="n">strategic_plan</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
        <span class="n">director_context</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">plan_block</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                <span class="n">plan_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STRATEGIC PLAN (from orchestrator/manager):</span><span class="se">\n</span><span class="si">{</span><span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">plan_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STRATEGIC PLAN (from orchestrator/manager):</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">)[:</span><span class="mi">1500</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">director_context</span><span class="p">:</span>
            <span class="n">plan_block</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DIRECTOR CONTEXT: </span><span class="si">{</span><span class="n">director_context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">plan_block</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="p">]</span>

        <span class="c1"># Build gated history messages from filtered history then cap</span>
        <span class="n">history_msgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_history</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_traces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">filtered_history</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">USER_MESSAGE</span><span class="p">,</span> <span class="n">ASSISTANT_MESSAGE</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_history</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">role</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">USER_MESSAGE</span> <span class="k">else</span> <span class="s2">&quot;assistant&quot;</span>
                    <span class="n">history_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)})</span>
                <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">ACTION</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_traces</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">history_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Calling tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2"> with args: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">})</span>
                <span class="k">elif</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="n">OBSERVATION</span><span class="p">,</span> <span class="n">GLOBAL_OBSERVATION</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_traces</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">GLOBAL_OBSERVATION</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_global_updates</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">content</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_truncate_len</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obs_truncate_len</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;... (truncated)&quot;</span>
                    <span class="n">history_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Tool result: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">history_msgs</span> <span class="o">=</span> <span class="n">history_msgs</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_history</span><span class="p">:]</span>

        <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">history_msgs</span><span class="p">)</span>
        
        <span class="c1"># Only add task as final message if this is the first iteration (no tool results yet)</span>
        <span class="c1"># Re-adding task after tool results confuses the LLM into thinking more work is needed</span>
        <span class="n">has_tool_results</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">OBSERVATION</span><span class="p">,</span> <span class="n">GLOBAL_OBSERVATION</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">filtered_history</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_tool_results</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">})</span>
        
        <span class="k">return</span> <span class="n">messages</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_tools_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build OpenAI tools schema.</span>
<span class="sd">        </span>
<span class="sd">        If actual tool objects are available, derive JSON Schema from their</span>
<span class="sd">        Pydantic args_schema (types + required). Otherwise, fall back to the</span>
<span class="sd">        config-provided arg names as string-typed required fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tools_schema</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_prune_properties</span><span class="p">(</span><span class="n">props</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="n">pruned</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="p">(</span><span class="n">props</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">pruned</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
                    <span class="k">continue</span>
                <span class="n">entry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># pick a reasonable type if union</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">t</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)),</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                
                <span class="c1"># For array types, preserve the items field (required for OpenAI function calling)</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span> <span class="ow">and</span> <span class="s2">&quot;items&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">):</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enum&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;enum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;enum&quot;</span><span class="p">]</span>
                <span class="n">pruned</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
            <span class="k">return</span> <span class="n">pruned</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_descriptions</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">tool_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tool_obj</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool_obj</span><span class="p">,</span> <span class="s2">&quot;args_schema&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">schema</span> <span class="o">=</span> <span class="n">tool_obj</span><span class="o">.</span><span class="n">args_schema</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span>  <span class="c1"># type: ignore[attr-defined]</span>
                        <span class="n">properties</span> <span class="o">=</span> <span class="n">_prune_properties</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="p">{}))</span>
                        <span class="n">required</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
                        <span class="n">tools_schema</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span>
                                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="n">required</span><span class="p">,</span>
                                <span class="p">},</span>
                            <span class="p">},</span>
                        <span class="p">})</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

        <span class="c1"># Fallback to config-only schema (string-typed)</span>
        <span class="k">for</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_descriptions</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Parameter: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">}</span>
            <span class="n">tools_schema</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span>
                        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">})</span>

        <span class="k">return</span> <span class="n">tools_schema</span>

    <span class="c1"># Public hook for factory to inject tool objects</span>
<div class="viewcode-block" id="ReActPlanner.configure_tools">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ReActPlanner.configure_tools">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">configure_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Accept list-like input as well</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span> <span class="o">=</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;tool</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">t</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tools</span><span class="p">)}</span>  <span class="c1"># type: ignore</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tool_objects</span> <span class="o">=</span> <span class="kc">None</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_inject_model_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">tool_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inject MODEL_DIR environment variable if needed.</span>
<span class="sd">        </span>
<span class="sd">        Matches the validation logic from text-based mode (lines 396-414).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_args_for_tool</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;model_dir&quot;</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">env_model_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MODEL_DIR&quot;</span><span class="p">)</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_dir&quot;</span><span class="p">)</span>
            <span class="n">placeholder_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;model_dir&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{model_dir}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;$</span><span class="si">{MODEL_DIR}</span><span class="s2">&quot;</span><span class="p">}</span>
            
            <span class="n">needs_inject</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">md</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">md</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">placeholder_vals</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="c1"># Validate directory existence (same as text-based mode)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">needs_inject</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_os</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
                        <span class="n">needs_inject</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;ReActPlanner._inject_model_dir: &#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid directory, using env MODEL_DIR&quot;</span><span class="p">,</span>
                            <span class="n">md</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">needs_inject</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">needs_inject</span> <span class="ow">and</span> <span class="n">env_model_dir</span><span class="p">:</span>
                <span class="n">tool_args</span><span class="p">[</span><span class="s2">&quot;model_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_model_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;ReActPlanner._inject_model_dir: Injected MODEL_DIR=&#39;</span><span class="si">%s</span><span class="s2">&#39; for tool=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">env_model_dir</span><span class="p">,</span> <span class="n">tool_name</span>
                <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">tool_args</span></div>



<div class="viewcode-block" id="MathPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.MathPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MathPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Heuristic planner for math Q&amp;A and calculations.</span>

<span class="sd">    Routes tasks to either the &#39;calculator&#39; tool (arithmetic/numeric queries)</span>
<span class="sd">    or the &#39;math_qa&#39; tool (conceptual math questions and formulas).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>

<div class="viewcode-block" id="MathPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.MathPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">task_description</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">is_calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_looks_like_calculation</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MathPlanner decision is_calc=</span><span class="si">{</span><span class="n">is_calc</span><span class="si">}</span><span class="s2"> task=&#39;</span><span class="si">{</span><span class="n">task_description</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_calc</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="s2">&quot;calculator&quot;</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;expression&quot;</span><span class="p">:</span> <span class="n">task_description</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="s2">&quot;math_qa&quot;</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">task_description</span><span class="p">})</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_looks_like_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Contains digits with math operators or caret/power words</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">op</span> <span class="ow">in</span> <span class="n">t</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">t</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;plus&quot;</span><span class="p">,</span> <span class="s2">&quot;minus&quot;</span><span class="p">,</span> <span class="s2">&quot;times&quot;</span><span class="p">,</span> <span class="s2">&quot;multiplied by&quot;</span><span class="p">,</span> <span class="s2">&quot;divided by&quot;</span><span class="p">,</span> <span class="s2">&quot;over&quot;</span><span class="p">,</span> <span class="s2">&quot;mod&quot;</span><span class="p">,</span> <span class="s2">&quot;modulo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;remainder&quot;</span><span class="p">,</span> <span class="s2">&quot;percent of&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f&quot;</span><span class="p">,</span> <span class="s2">&quot;power of&quot;</span><span class="p">,</span> <span class="s2">&quot;raised to&quot;</span><span class="p">,</span> <span class="s2">&quot;squared&quot;</span><span class="p">,</span> <span class="s2">&quot;cubed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sqrt&quot;</span><span class="p">,</span> <span class="s2">&quot;square root&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;ln&quot;</span><span class="p">,</span> <span class="s2">&quot;sin&quot;</span><span class="p">,</span> <span class="s2">&quot;cos&quot;</span><span class="p">,</span> <span class="s2">&quot;tan&quot;</span><span class="p">,</span> <span class="s2">&quot;calculate&quot;</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Numbers present with query verbs often imply calc</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b\d+(?:[\.\d]*)?\b&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">t</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;calculate&quot;</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">,</span> <span class="s2">&quot;what is&quot;</span><span class="p">,</span> <span class="s2">&quot;what&#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;solve&quot;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="StrategicDecomposerPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.StrategicDecomposerPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StrategicDecomposerPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hybrid planner that can create steps or decompose orchestrator phases into</span>
<span class="sd">    worker-specific steps for a domain manager (e.g., PBI Manager).</span>

<span class="sd">    Behavior:</span>
<span class="sd">    - Reads a strategic plan from request context (set by an upstream orchestrator)</span>
<span class="sd">    - If inference_gateway is provided: Uses LLM to create steps based on orchestrator phase + previous manager outputs</span>
<span class="sd">    - Otherwise: Maps high-level phases to local workers using simple heuristics (decomposition)</span>
<span class="sd">    - Returns an Action targeting the primary local worker with the plan containing steps</span>

<span class="sd">    Config:</span>
<span class="sd">      - worker_keys: list[str] of local workers (e.g., [&quot;schema&quot;, &quot;dax&quot;, &quot;validator&quot;])</span>
<span class="sd">      - default_worker: optional fallback (default: first worker)</span>
<span class="sd">      - inference_gateway: optional BaseInferenceGateway for LLM-based step creation</span>
<span class="sd">      - planning_prompt: optional str custom prompt for step creation</span>
<span class="sd">      - manager_worker_key: optional str to identify which orchestrator phase is for this manager</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">default_worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inference_gateway</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">planning_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">manager_worker_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">history_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HistoryFilter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="o">=</span> <span class="n">worker_keys</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="o">=</span> <span class="n">default_worker</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">inference_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planning_prompt</span> <span class="o">=</span> <span class="n">planning_prompt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_planning_prompt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span> <span class="o">=</span> <span class="n">manager_worker_key</span>  <span class="c1"># e.g., &quot;powerbi-analysis&quot;, &quot;powerbi-designer&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..policies.history_filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">ManagerHistoryFilter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_filter</span> <span class="o">=</span> <span class="n">history_filter</span> <span class="ow">or</span> <span class="n">ManagerHistoryFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_planning_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;You are a manager planner creating execution steps for a domain-specific task.</span>

<span class="s2">Your role:</span>
<span class="s2">1. Analyze the orchestrator phase input and any previous manager outputs</span>
<span class="s2">2. Break the task into concrete, sequential steps for your domain workers</span>
<span class="s2">3. Identify which local workers/specialists are needed for each step</span>
<span class="s2">4. Ensure steps build on previous outputs when available</span>

<span class="s2">Available workers: </span><span class="si">{worker_keys}</span>

<span class="s2">Return JSON:</span>
<span class="s2">{{</span>
<span class="s2">  &quot;phases&quot;: [</span>
<span class="s2">    {{&quot;name&quot;: &quot;&lt;step name&gt;&quot;, &quot;worker&quot;: &quot;&lt;worker_key&gt;&quot;, &quot;goals&quot;: &quot;&lt;what to achieve&gt;&quot;, &quot;notes&quot;: &quot;&lt;key context&gt;&quot;}},</span>
<span class="s2">    ...</span>
<span class="s2">  ],</span>
<span class="s2">  &quot;primary_worker&quot;: &quot;&lt;worker_key&gt;&quot;,</span>
<span class="s2">  &quot;rationale&quot;: &quot;Why this step plan will succeed&quot;</span>
<span class="s2">}}&quot;&quot;&quot;</span>

<div class="viewcode-block" id="StrategicDecomposerPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.StrategicDecomposerPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="c1"># Pull upstream strategic plan from context or history</span>
        <span class="n">upstream</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">upstream</span><span class="p">:</span>
            <span class="c1"># Try to locate in history (manager added it earlier)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">upstream</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;strategic_plan&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">upstream</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Debug logging</span>
        <span class="c1"># Normalize plan data</span>
        <span class="n">plan_obj</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">upstream</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">plan_obj</span> <span class="o">=</span> <span class="n">upstream</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">upstream</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plan_obj</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">phases_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">phases_in</span> <span class="o">=</span> <span class="n">plan_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        
        <span class="c1"># Log when no phases found (this is the issue reported)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phases_in</span><span class="p">:</span>
            <span class="n">has_context</span> <span class="o">=</span> <span class="n">upstream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">has_history</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;strategic_plan&quot;</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;StrategicDecomposerPlanner: No orchestrator phase found (manager_worker_key=</span><span class="si">%s</span><span class="s2">, phases_in=</span><span class="si">%d</span><span class="s2">), using decomposition. upstream_from_context=</span><span class="si">%s</span><span class="s2">, upstream_from_history=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">phases_in</span><span class="p">),</span>
                <span class="n">has_context</span><span class="p">,</span>
                <span class="n">has_history</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">upstream</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                    <span class="n">upstream_preview</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">upstream</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">300</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">upstream</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">upstream</span><span class="p">)[:</span><span class="mi">300</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;StrategicDecomposerPlanner: upstream structure preview=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">upstream_preview</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># Extract orchestrator phase assigned to this manager</span>
        <span class="n">orchestrator_phase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span> <span class="ow">and</span> <span class="n">phases_in</span><span class="p">:</span>
            <span class="c1"># Find phase(s) where worker matches this manager&#39;s worker key</span>
            <span class="n">matching_phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phases_in</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matching_phases</span><span class="p">:</span>
                <span class="c1"># Use phase index from request context to select the correct phase</span>
                <span class="n">phase_index</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;orchestrator_phase_index&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phase_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">phase_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_phases</span><span class="p">):</span>
                    <span class="n">orchestrator_phase</span> <span class="o">=</span> <span class="n">matching_phases</span><span class="p">[</span><span class="n">phase_index</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;StrategicDecomposerPlanner: Using phase index </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> for manager_worker_key=</span><span class="si">%s</span><span class="s2">, phase=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                        <span class="n">phase_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">matching_phases</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span><span class="p">,</span>
                        <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unnamed&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback: use first matching phase if index not available or invalid</span>
                    <span class="n">orchestrator_phase</span> <span class="o">=</span> <span class="n">matching_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">phase_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;StrategicDecomposerPlanner: Invalid phase_index=</span><span class="si">%s</span><span class="s2"> (expected 0-</span><span class="si">%d</span><span class="s2">), using first phase&quot;</span><span class="p">,</span>
                            <span class="n">phase_index</span><span class="p">,</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">matching_phases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="p">)</span>
                
                <span class="c1"># Combine task_description with orchestrator phase info</span>
                <span class="k">if</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">):</span>
                    <span class="n">task_description</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">,</span> <span class="n">task_description</span><span class="p">)</span>

        <span class="c1"># Filter history using hierarchical filter (manager gets phase-relevant context only)</span>
        <span class="n">phase_index</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;orchestrator_phase_index&quot;</span><span class="p">)</span>
        <span class="n">filter_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;manager&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phase_id&quot;</span><span class="p">:</span> <span class="n">phase_index</span><span class="p">,</span>
            <span class="s2">&quot;previous_phase_id&quot;</span><span class="p">:</span> <span class="n">phase_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">phase_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">phase_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">filtered_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_filter</span><span class="o">.</span><span class="n">filter_for_prompt</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">filter_context</span><span class="p">)</span>
        
        <span class="c1"># Extract previous manager outputs from filtered history</span>
        <span class="c1"># Priority: synthesized outputs from synthesizer agent &gt; regular manager outputs</span>
        <span class="n">previous_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">synthesized_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">filtered_history</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
                
            <span class="n">entry_type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            
            <span class="c1"># Look for synthesized outputs first (from synthesizer agent)</span>
            <span class="c1"># These are stored as global updates with type=&quot;synthesis&quot;</span>
            <span class="k">if</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">SYNTHESIS</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># Build comprehensive output including both summary and actual data</span>
                    <span class="n">output_parts</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="c1"># Add synthesized summary</span>
                    <span class="n">synthesized_summary</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesized_summary&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">synthesized_summary</span><span class="p">:</span>
                        <span class="c1"># Try to get from full_result</span>
                        <span class="n">full_result</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;full_result&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">full_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">synthesized_summary</span> <span class="o">=</span> <span class="n">full_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">full_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">synthesized_summary</span><span class="p">:</span>
                        <span class="n">output_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Summary: </span><span class="si">{</span><span class="n">synthesized_summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Add actual data (structured data for planning)</span>
                    <span class="n">actual_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actual_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">actual_data</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">actual_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">actual_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">actual_data</span><span class="p">)</span>
                            <span class="n">output_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual Data:</span><span class="se">\n</span><span class="si">{</span><span class="n">data_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">output_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual Data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">actual_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Add worker results for context</span>
                    <span class="n">worker_results</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker_results&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">if</span> <span class="n">worker_results</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">results_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">worker_results</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">output_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worker Results:</span><span class="se">\n</span><span class="si">{</span><span class="n">results_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    
                    <span class="k">if</span> <span class="n">output_parts</span><span class="p">:</span>
                        <span class="n">synthesized_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_parts</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">synthesized_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            
            <span class="c1"># Also collect regular manager outputs as fallback</span>
            <span class="k">if</span> <span class="n">entry_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">FINAL</span><span class="p">,</span> <span class="n">ASSISTANT_MESSAGE</span><span class="p">,</span> <span class="s2">&quot;manager_result&quot;</span><span class="p">]:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
                        <span class="n">previous_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">summary</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">previous_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            
            <span class="c1"># Limit to avoid token overflow (prioritize synthesized)</span>
            <span class="k">if</span> <span class="n">synthesized_outputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">synthesized_outputs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_outputs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">break</span>
        
        <span class="c1"># Prefer synthesized outputs, fall back to regular outputs</span>
        <span class="n">final_previous_outputs</span> <span class="o">=</span> <span class="n">synthesized_outputs</span> <span class="k">if</span> <span class="n">synthesized_outputs</span> <span class="k">else</span> <span class="n">previous_outputs</span>

        <span class="c1"># If LLM is available and we have orchestrator phase, create steps using LLM</span>
        <span class="c1"># Reuse StrategicPlanner&#39;s pattern but with manager-specific context</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="ow">and</span> <span class="n">orchestrator_phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;StrategicDecomposerPlanner using LLM to create steps: manager_worker_key=</span><span class="si">%s</span><span class="s2">, orchestrator_phase=</span><span class="si">%s</span><span class="s2">, has_synthesized_outputs=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span><span class="p">,</span>
                <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unnamed&quot;</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">synthesized_outputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">llm_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_steps_with_llm</span><span class="p">(</span>
                <span class="n">task_description</span><span class="p">,</span> <span class="n">orchestrator_phase</span><span class="p">,</span> <span class="n">final_previous_outputs</span><span class="p">,</span> <span class="n">plan_obj</span><span class="p">,</span> <span class="n">history</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">llm_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">llm_result</span>
            <span class="c1"># If LLM creation failed, fall through to decomposition</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LLM step creation failed, falling back to decomposition&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;StrategicDecomposerPlanner: No LLM configured, using decomposition&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">orchestrator_phase</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;StrategicDecomposerPlanner: No orchestrator phase found (manager_worker_key=</span><span class="si">%s</span><span class="s2">, phases_in=</span><span class="si">%d</span><span class="s2">), using decomposition&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">phases_in</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Fallback: Decompose orchestrator phases using heuristics (original behavior)</span>
        <span class="n">phases_out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_pick_worker</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">goals</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">goals</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">notes</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;lint&quot;</span><span class="p">,</span> <span class="s2">&quot;integrity&quot;</span><span class="p">,</span> <span class="s2">&quot;consistency&quot;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="s2">&quot;validator&quot;</span> <span class="k">if</span> <span class="s2">&quot;validator&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dax&quot;</span><span class="p">,</span> <span class="s2">&quot;measure&quot;</span><span class="p">,</span> <span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;kpi&quot;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="s2">&quot;dax&quot;</span> <span class="k">if</span> <span class="s2">&quot;dax&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>
            <span class="c1"># Default for schema-related analysis/editing</span>
            <span class="k">return</span> <span class="s2">&quot;schema&quot;</span> <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>

        <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">phases_in</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">ph</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Phase&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">goals</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">ph</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">notes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">ph</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="p">(</span><span class="n">ph</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
                <span class="n">worker</span> <span class="o">=</span> <span class="n">_pick_worker</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">goals</span><span class="p">,</span> <span class="n">notes</span><span class="p">)</span>
            <span class="n">phases_out</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">worker</span><span class="p">,</span>
                <span class="s2">&quot;goals&quot;</span><span class="p">:</span> <span class="n">goals</span><span class="p">,</span>
                <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">notes</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">phases_out</span><span class="p">:</span>
            <span class="c1"># Fallback: single schema phase</span>
            <span class="n">primary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">phases_out</span> <span class="o">=</span> <span class="p">[{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Execute Task&quot;</span><span class="p">,</span>
                <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">primary</span> <span class="ow">or</span> <span class="s2">&quot;schema&quot;</span><span class="p">,</span>
                <span class="s2">&quot;goals&quot;</span><span class="p">:</span> <span class="n">task_description</span><span class="p">,</span>
                <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="s2">&quot;Generated by StrategicDecomposerPlanner (no upstream plan found)&quot;</span><span class="p">,</span>
            <span class="p">}]</span>

        <span class="n">primary_worker</span> <span class="o">=</span> <span class="n">phases_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>
        <span class="k">if</span> <span class="n">primary_worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
            <span class="n">primary_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compose a local plan object for downstream workers</span>
        <span class="n">local_plan</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;primary_worker&quot;</span><span class="p">:</span> <span class="n">primary_worker</span><span class="p">,</span>
            <span class="s2">&quot;task_type&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">plan_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_type&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;analysis&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phases&quot;</span><span class="p">:</span> <span class="n">phases_out</span><span class="p">,</span>
            <span class="s2">&quot;rationale&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">plan_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rationale&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;Decomposed upstream plan for domain execution.&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Log and return as Action to the primary worker; manager will run follow-ups</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;StrategicDecomposerPlanner.local_plan=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">local_plan</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">800</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">primary_worker</span><span class="p">),</span>
            <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;strategic_plan&quot;</span><span class="p">:</span> <span class="n">local_plan</span><span class="p">,</span>
                <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="n">task_description</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_steps_with_llm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">orchestrator_phase</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">previous_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">plan_obj</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Action</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create steps using LLM - reuses StrategicPlanner&#39;s pattern with manager-specific context.&quot;&quot;&quot;</span>
        <span class="n">workers_list</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;StrategicDecomposerPlanner._create_steps_with_llm: Invoking LLM with orchestrator_phase=</span><span class="si">%s</span><span class="s2">, previous_outputs=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unnamed&quot;</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">previous_outputs</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Replace {worker_keys} placeholder (use replace to avoid KeyError with JSON braces in prompt)</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_prompt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{worker_keys}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">workers_list</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}]</span>
        
        <span class="c1"># Build context similar to StrategicPlanner but with manager-specific info</span>
        <span class="n">context_parts</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Add orchestrator phase context (manager-specific)</span>
        <span class="n">phase_name</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">phase_goals</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">,</span> <span class="n">task_description</span><span class="p">)</span>
        <span class="n">phase_notes</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ORCHESTRATOR PHASE:</span><span class="se">\n</span><span class="s2">Name: </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">Goals: </span><span class="si">{</span><span class="n">phase_goals</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phase_notes</span><span class="p">:</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Notes: </span><span class="si">{</span><span class="n">phase_notes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Add previous manager outputs (manager-specific) - include actual data</span>
        <span class="k">if</span> <span class="n">previous_outputs</span><span class="p">:</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PREVIOUS MANAGER OUTPUTS (INCLUDES ACTUAL DATA):&quot;</span><span class="p">)</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;IMPORTANT: The following outputs contain ACTUAL DATA from previous manager analysis.&quot;</span><span class="p">)</span>
            <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Use this data directly in your step planning - do not assume data needs to be re-queried.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">previous_outputs</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Include full output (may contain actual data) - don&#39;t truncate too much</span>
                <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Previous Manager Output </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">)[:</span><span class="mi">5000</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Add data model context (same as StrategicPlanner)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span> <span class="k">as</span> <span class="n">_ctx</span>
            <span class="n">data_model_context</span> <span class="o">=</span> <span class="n">_ctx</span><span class="p">(</span><span class="s2">&quot;data_model_context&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_model_context</span><span class="p">:</span>
                <span class="n">context_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DATA MODEL CONTEXT:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data_model_context</span><span class="p">)[:</span><span class="mi">2000</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">if</span> <span class="n">context_parts</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_parts</span><span class="p">)})</span>
        
        <span class="c1"># Add task (same pattern as StrategicPlanner)</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Task: </span><span class="si">{</span><span class="n">task_description</span><span class="si">}</span>
<span class="s2">Available workers: [</span><span class="si">{</span><span class="n">workers_list</span><span class="si">}</span><span class="s2">]</span>

<span class="s2">Create a step-by-step plan to accomplish this task using your domain workers.</span>

<span class="s2">IMPORTANT: Previous manager outputs above include ACTUAL DATA (tables, columns, SQL queries, DAX expressions, etc.).</span>
<span class="s2">- Use this actual data directly in your step planning</span>
<span class="s2">- Reference specific data values in your step goals (e.g., &quot;Use the SQL query from previous output&quot;)</span>
<span class="s2">- Do not plan steps that re-query data that&#39;s already provided</span>
<span class="s2">- Build steps that work with the actual data provided</span>

<span class="s2">Ensure steps build on previous outputs when available.</span>
<span class="s2">Return JSON with phases array (use &quot;phases&quot; not &quot;steps&quot;).</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        
        <span class="c1"># Reuse StrategicPlanner&#39;s LLM invocation and parsing pattern</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        
        <span class="c1"># Parse using same pattern as StrategicPlanner</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Look for &quot;phases&quot; instead of &quot;plan&quot; for manager steps</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{[\s\S]*&quot;phases&quot;[\s\S]*\}&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="c1"># Fallback: try to find any JSON with plan</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{[\s\S]*&quot;plan&quot;[\s\S]*\}&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="c1"># Support both &quot;phases&quot; (manager format) and &quot;plan.phases&quot; (orchestrator format)</span>
                <span class="n">plan_data</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="s2">&quot;plan&quot;</span> <span class="ow">in</span> <span class="n">parsed</span> <span class="ow">and</span> <span class="s2">&quot;phases&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parsed</span> <span class="k">else</span> <span class="n">parsed</span>
                <span class="n">phases_out</span> <span class="o">=</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span> <span class="p">[])</span>
                
                <span class="k">if</span> <span class="n">phases_out</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases_out</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># Validate and correct workers (same as StrategicPlanner)</span>
                    <span class="k">for</span> <span class="n">ph</span> <span class="ow">in</span> <span class="n">phases_out</span><span class="p">:</span>
                        <span class="n">worker</span> <span class="o">=</span> <span class="n">ph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">worker</span> <span class="ow">and</span> <span class="n">worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
                            <span class="n">ph</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_worker</span><span class="p">(</span>
                                <span class="n">ph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                <span class="n">ph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                <span class="n">ph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                            <span class="p">)</span>
                    
                    <span class="n">primary_worker</span> <span class="o">=</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;primary_worker&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">phases_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">phases_out</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">primary_worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
                        <span class="n">primary_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>
                    
                    <span class="n">local_plan</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;primary_worker&quot;</span><span class="p">:</span> <span class="n">primary_worker</span><span class="p">,</span>
                        <span class="s2">&quot;task_type&quot;</span><span class="p">:</span> <span class="n">plan_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_type&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;phases&quot;</span><span class="p">:</span> <span class="n">phases_out</span><span class="p">,</span>
                        <span class="s2">&quot;rationale&quot;</span><span class="p">:</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rationale&quot;</span><span class="p">,</span> <span class="s2">&quot;Created steps based on orchestrator phase input and previous outputs.&quot;</span><span class="p">),</span>
                    <span class="p">}</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;StrategicDecomposerPlanner created </span><span class="si">%d</span><span class="s2"> steps via LLM, primary_worker=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">phases_out</span><span class="p">),</span>
                        <span class="n">primary_worker</span>
                    <span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">Action</span><span class="p">(</span>
                        <span class="n">tool_name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">primary_worker</span><span class="p">),</span>
                        <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;strategic_plan&quot;</span><span class="p">:</span> <span class="n">local_plan</span><span class="p">,</span>
                            <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="n">task_description</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse step plan: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, falling back to decomposition&quot;</span><span class="p">)</span>
        
        <span class="c1"># Fallback: return single step (will be handled by decomposition logic below)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_pick_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">goals</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">notes</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pick worker based on heuristics.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">goals</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">notes</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;lint&quot;</span><span class="p">,</span> <span class="s2">&quot;integrity&quot;</span><span class="p">,</span> <span class="s2">&quot;consistency&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;validator&quot;</span> <span class="k">if</span> <span class="s2">&quot;validator&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;dax&quot;</span><span class="p">,</span> <span class="s2">&quot;measure&quot;</span><span class="p">,</span> <span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;kpi&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;dax&quot;</span> <span class="k">if</span> <span class="s2">&quot;dax&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>
        <span class="k">return</span> <span class="s2">&quot;schema&quot;</span> <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span></div>



<div class="viewcode-block" id="ManagerScriptPlanner">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ManagerScriptPlanner">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ManagerScriptPlanner</span><span class="p">(</span><span class="n">BasePlanner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LLM-backed planner that creates explicit tool-call scripts for managers.</span>

<span class="sd">    The manager remains the planner while workers become deterministic executors.</span>
<span class="sd">    This planner inspects the director goal (orchestrator phase) plus previous</span>
<span class="sd">    manager outputs and returns a JSON script describing the exact worker/tool</span>
<span class="sd">    calls required to accomplish the goal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_specs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">default_worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inference_gateway</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">planning_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">manager_worker_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_worker_specs</span><span class="p">(</span><span class="n">worker_specs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_specs</span> <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="o">=</span> <span class="n">default_worker</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">inference_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planning_prompt</span> <span class="o">=</span> <span class="n">planning_prompt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_planning_prompt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span> <span class="o">=</span> <span class="n">manager_worker_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span> <span class="o">=</span> <span class="n">StrategicDecomposerPlanner</span><span class="p">(</span>
            <span class="n">worker_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">,</span>
            <span class="n">default_worker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span><span class="p">,</span>
            <span class="n">inference_gateway</span><span class="o">=</span><span class="n">inference_gateway</span><span class="p">,</span>
            <span class="n">manager_worker_key</span><span class="o">=</span><span class="n">manager_worker_key</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_script_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ScriptPlan</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ScriptPlan</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">ScriptPlan</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ScriptPlan</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ScriptPlan</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">response</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{[\s\S]*</span><span class="se">\&quot;</span><span class="s2">script</span><span class="se">\&quot;</span><span class="s2">[\s\S]*\}&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ScriptPlan</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ManagerScriptPlanner: script validation error </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ve</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_worker_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">normalized</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">worker</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">normalized</span>

<div class="viewcode-block" id="ManagerScriptPlanner.plan">
<a class="viewcode-back" href="../../../api/index.html#agent_framework.components.planners.ManagerScriptPlanner.plan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ManagerScriptPlanner has no inference gateway, falling back to StrategicDecomposer&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>

        <span class="n">orchestrator_phase</span><span class="p">,</span> <span class="n">goal_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_orchestrator_phase</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
        <span class="n">previous_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_previous_outputs</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

        <span class="n">worker_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_worker_catalog</span><span class="p">()</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planning_prompt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{worker_catalog}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">worker_catalog</span><span class="p">)</span>

        <span class="n">context_sections</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Director Goal: </span><span class="si">{</span><span class="n">goal_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">orchestrator_phase</span><span class="p">:</span>
            <span class="n">phase_name</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">phase_notes</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">context_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase Name: </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_notes</span><span class="p">:</span>
                <span class="n">context_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Director Notes: </span><span class="si">{</span><span class="n">phase_notes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous_outputs</span><span class="p">:</span>
            <span class="n">context_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Previous Manager Outputs (actual data):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">previous_outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">context_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_sections</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Return strict JSON with fields &#39;thought&#39; and &#39;script&#39;.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ManagerScriptPlanner invoking LLM for script generation (worker_key=</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">plan_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_script_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plan_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ManagerScriptPlanner: unable to parse script response, falling back&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="n">task_description</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>

        <span class="n">script_steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">plan_model</span><span class="o">.</span><span class="n">script</span><span class="p">]</span>
        <span class="n">script_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_script_workers</span><span class="p">(</span><span class="n">script_steps</span><span class="p">)</span>
        <span class="n">primary_worker</span> <span class="o">=</span> <span class="n">script_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;worker&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">script_steps</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span>
        <span class="k">if</span> <span class="n">primary_worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
            <span class="n">primary_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;goal&quot;</span><span class="p">:</span> <span class="n">goal_text</span><span class="p">,</span>
            <span class="s2">&quot;thought&quot;</span><span class="p">:</span> <span class="n">plan_model</span><span class="o">.</span><span class="n">thought</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">orchestrator_phase</span> <span class="ow">and</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">):</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ManagerScriptPlanner produced script with </span><span class="si">%d</span><span class="s2"> step(s)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">script_steps</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Action</span><span class="p">(</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">primary_worker</span><span class="p">,</span>
            <span class="n">tool_args</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;script&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_guided_tool_args</span><span class="p">(</span><span class="n">script_steps</span><span class="p">),</span>
                <span class="s2">&quot;script_metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
                <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="n">goal_text</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_strip_guided_tool_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove tool_name/args from guided steps so workers reason autonomously.&quot;&quot;&quot;</span>
        <span class="n">sanitized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;execution_mode&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;guided&quot;</span><span class="p">:</span>
                <span class="n">stripped</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                <span class="n">stripped</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tool_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">stripped</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">sanitized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sanitized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sanitized</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_script_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure each script step references a known worker.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">steps</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fallback_worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_worker</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_keys</span><span class="p">:</span>
                <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fallback_worker</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;ManagerScriptPlanner: step </span><span class="si">%d</span><span class="s2"> references unknown worker &#39;</span><span class="si">%s</span><span class="s2">&#39; and no fallback is available&quot;</span><span class="p">,</span>
                    <span class="n">idx</span><span class="p">,</span>
                    <span class="n">worker</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">fixed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="n">fixed</span><span class="p">[</span><span class="s2">&quot;worker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_worker</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;ManagerScriptPlanner: step </span><span class="si">%d</span><span class="s2"> referenced unknown worker &#39;</span><span class="si">%s</span><span class="s2">&#39;. Reassigning to fallback worker &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
                <span class="n">idx</span><span class="p">,</span>
                <span class="n">worker</span><span class="p">,</span>
                <span class="n">fallback_worker</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fixed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalized</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_select_orchestrator_phase</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fallback_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span>

        <span class="n">upstream</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">upstream</span><span class="p">:</span>
            <span class="n">upstream</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;strategic_plan&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">plan_obj</span> <span class="o">=</span> <span class="n">upstream</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">upstream</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">plan_obj</span> <span class="o">=</span> <span class="n">upstream</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">upstream</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">phases_in</span> <span class="o">=</span> <span class="n">plan_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">orchestrator_phase</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phases_in</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager_worker_key</span><span class="p">]</span>
            <span class="n">phase_index</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;orchestrator_phase_index&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matching</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">phase_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">):</span>
                    <span class="n">orchestrator_phase</span> <span class="o">=</span> <span class="n">matching</span><span class="p">[</span><span class="n">phase_index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">orchestrator_phase</span> <span class="o">=</span> <span class="n">matching</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">goal_text</span> <span class="o">=</span> <span class="n">orchestrator_phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">orchestrator_phase</span> <span class="k">else</span> <span class="n">fallback_task</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">goal_text</span><span class="p">:</span>
            <span class="n">goal_text</span> <span class="o">=</span> <span class="n">fallback_task</span>
        <span class="k">return</span> <span class="n">orchestrator_phase</span><span class="p">,</span> <span class="n">goal_text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_previous_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">synthesized_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regular_outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">entry_type</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry_type</span> <span class="o">==</span> <span class="n">SYNTHESIS</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesized_summary&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">summary</span><span class="p">:</span>
                        <span class="n">full_result</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;full_result&quot;</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">full_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">summary</span> <span class="o">=</span> <span class="n">full_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">full_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
                    <span class="n">actual_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actual_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
                    <span class="n">output_parts</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
                        <span class="n">output_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">actual_data</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
                            <span class="n">output_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">actual_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">5000</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">output_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">actual_data</span><span class="p">)[:</span><span class="mi">5000</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">output_parts</span><span class="p">:</span>
                        <span class="n">synthesized_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_parts</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">entry_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;final&quot;</span><span class="p">,</span> <span class="s2">&quot;assistant_message&quot;</span><span class="p">,</span> <span class="s2">&quot;manager_result&quot;</span><span class="p">}:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">summary</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
                        <span class="n">regular_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">regular_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">synthesized_outputs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">synthesized_outputs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">regular_outputs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">synthesized_outputs</span> <span class="k">if</span> <span class="n">synthesized_outputs</span> <span class="k">else</span> <span class="n">regular_outputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_worker_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_specs</span><span class="p">:</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tools</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
                <span class="n">tool_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_name&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">tool_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tool_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tool_lines</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tool_lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_planning_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;You are a tactical Power BI manager. Your director gives you one goal at a time.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;You must respond with a STRICT JSON object containing a &#39;thought&#39; string and a &#39;script&#39; array.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Each script entry must include: name, worker (from the list below), tool_name (exact tool), args (object), &quot;</span>
            <span class="s2">&quot;and MAY include execution_mode when needed.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Workers and their tools:</span><span class="se">\n</span><span class="si">{worker_catalog}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Rules:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;1. Think like a programmer writing a script.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;2. Ensure prerequisites are satisfied before any dependent tool (e.g., gather data before validation).</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;3. Keep the script minimal and ordered. No speculative or redundant calls.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;4. Only use the tools listed for each worker.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;5. Choose an execution mode per step:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    &#39;direct&#39; (default) when every argument is concrete and the worker can run it deterministically.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    &#39;guided&#39; when the worker must reason, fill placeholders, or iterate on freshly retrieved data. &quot;</span>
            <span class="s2">&quot;Provide the best available hints in args, but expect the worker to adapt.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;6. Never delegate planning blindly  if you set execution_mode=&#39;guided&#39;, explain why in the step notes.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Example output:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="se">\&quot;</span><span class="s2">thought</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">List current relationships, then add the requested one.</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="se">\&quot;</span><span class="s2">script</span><span class="se">\&quot;</span><span class="s2">: [</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    {</span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">List relationships</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">worker</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">schema</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">tool_name</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">list_relationships</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">args</span><span class="se">\&quot;</span><span class="s2">: </span><span class="si">{}</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">execution_mode</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">direct</span><span class="se">\&quot;</span><span class="s2">},</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;    {</span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">Count columns per table</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">worker</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">schema</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">tool_name</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">list_columns</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">args</span><span class="se">\&quot;</span><span class="s2">: {</span><span class="se">\&quot;</span><span class="s2">table</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">&lt;table_from_previous&gt;</span><span class="se">\&quot;</span><span class="s2">}, </span><span class="se">\&quot;</span><span class="s2">execution_mode</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">guided</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">notes</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">Worker must iterate over each table returned earlier.</span><span class="se">\&quot;</span><span class="s2">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  ]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Project Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>