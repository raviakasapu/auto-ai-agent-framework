Chat-Driven Architecture
========================

The AI Agent Framework provides a natural language interface for BI model management, specifically for Tableau Model Definition Language (TMDL) manipulation.

Overview
--------

This architecture enables users to modify TMDL files through conversational commands like:

* "Create a relationship between 'SALES'[CustomerId] and 'CUSTOMERS'[Id]"
* "Deactivate relationship id: abc123"
* "Update relationship xyz789 to use bothDirections filtering"

Key Features
~~~~~~~~~~~~

* **Natural Language â†’ Tool Calls**: LLM interprets user requests and generates structured tool invocations
* **Fallback Heuristics**: Pattern-based parsing when LLM output is unparseable
* **Dual Modes**: LLM-driven (chat) and deterministic (environment variables) for testing
* **TMDL-Specific Tools**: Purpose-built for reading, writing, and modifying BI model relationships
* **Production Ready**: FastAPI integration with real-time progress tracking

Architecture Flow
-----------------

1. User provides natural language request
2. **LLMRouterPlanner** interprets the request:
   
   - Builds prompt with available tool specifications
   - Calls LLM via InferenceGateway
   - Expects JSON response: ``{"tool": "...", "args": {...}}``
   - Falls back to regex patterns if JSON parsing fails

3. **Agent Orchestrator** executes the action:
   
   - Validates arguments via Pydantic schemas
   - Executes the appropriate TMDL tool
   - Records action in memory
   - Publishes events for monitoring

4. **Tool** performs the operation:
   
   - Validates table/column existence
   - Generates TMDL block
   - Appends to ``Model/relationships.tmdl``
   - Returns structured result

Core Components
---------------

LLMRouterPlanner
~~~~~~~~~~~~~~~~

The **LLMRouterPlanner** is the intelligence layer that maps natural language to tool calls.

**Expected LLM Output:**

.. code-block:: json

   {
     "tool": "add_relationship",
     "args": {
       "model_dir": "/path/to/model",
       "from_table": "SALES",
       "from_column": "CustomerId",
       "to_table": "CUSTOMERS",
       "to_column": "Id",
       "is_active": true
     }
   }

**Fallback Heuristics** (when JSON parsing fails):

- **Update Detection**: Patterns like "update", "deactivate", "id: xxx"
- **Add Pattern**: Extracts ``'Table'[Column]`` syntax from text

TMDL Management Tools
~~~~~~~~~~~~~~~~~~~~~

**AddRelationshipTool**
  Creates new relationships between tables.
  
  Validates table/column existence, generates unique IDs, appends to ``relationships.tmdl``.

**UpdateRelationshipTool**
  Modifies existing relationships.
  
  Supports updating ``is_active``, cardinality, cross-filtering, and endpoints.

**TMDLReaderTool**
  Reads and parses TMDL files.

**TMDLWriterTool**
  Writes or appends content to TMDL files with optional backup.

Quick Start
-----------

Installation
~~~~~~~~~~~~

.. code-block:: bash

   # from repo root
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -e ./agent-framework-pypi
   pip install -r requirements.txt
   export MODEL_DIR=/absolute/path/to/your/Model

Run Demo
~~~~~~~~

.. code-block:: bash

   # Start FastAPI server
   uvicorn tests.simple_app:app --reload

   # Test natural language request
   curl -X POST http://127.0.0.1:8000/run \
     -H 'Content-Type: application/json' \
     -d '{"task":"Create relationship between '\''SALES'\''[CustomerId] and '\''CUSTOMERS'\''[Id]","config_path":"configs/agents/schema_editor_router.yaml"}'

Python API
~~~~~~~~~~

.. code-block:: python

   from deployment.factory import AgentFactory
   import asyncio
   import os

   os.environ["MODEL_DIR"] = "/path/to/model"

   async def main():
       agent = AgentFactory.create_from_yaml(
           "configs/agents/schema_editor_router.yaml"
       )
       
       result = await agent.run(
           "Create a relationship between 'SALES'[Amount] and 'REVENUE'[Total]"
       )
       
       print(f"Result: {result}")

   asyncio.run(main())

Configuration
-------------

Chat-Driven Mode (LLM Router)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**File:** ``configs/agents/schema_editor_router.yaml``

.. code-block:: yaml

   apiVersion: agent.framework/v1
   kind: Agent
   metadata:
     name: Schema-Editor-Router
   
   resources:
     inference_gateways:
       - name: mock-llm
         type: MockInferenceGateway  # Or OpenAIGateway
     tools:
       - name: add_rel
         type: AddRelationshipTool
       - name: upd_rel
         type: UpdateRelationshipTool
       - name: list_tables
         type: ListTablesTool

   spec:
     planner:
       type: LLMRouterPlanner
       config:
         inference_gateway: mock-llm
         default_model_dir: ${MODEL_DIR}
         log_details: true  # Optional: emit DEBUG logs with prompts/results
         tool_specs:
           - tool: add_relationship
             args: [model_dir, from_table, from_column, ...]
           - tool: update_relationship
             args: [model_dir, id, is_active, ...]
           - tool: list_tables
             args: [model_dir]

Deterministic Mode (Testing)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**File:** ``configs/agents/relationship_add.yaml``

.. code-block:: yaml

   apiVersion: agent.framework/v1
   kind: Agent
   spec:
     planner:
       type: SingleActionPlanner
       config:
         tool_name: add_rel
         tool_args:
           model_dir: ${MODEL_DIR}
           from_table: ${FROM_TABLE}
           from_column: ${FROM_COLUMN}
           to_table: ${TO_TABLE}
           to_column: ${TO_COLUMN}

Production Deployment
---------------------

Using OpenAI
~~~~~~~~~~~~

1. **Create Gateway:**

.. code-block:: python

   # agent_framework/gateways/inference.py
   from agent_framework import BaseInferenceGateway
   import openai

   class OpenAIGateway(BaseInferenceGateway):
       def __init__(self, api_key: str, model: str = "gpt-4"):
           self.client = openai.OpenAI(api_key=api_key)
           self.model = model
       
       def invoke(self, prompt: str, **kwargs) -> str:
           response = self.client.chat.completions.create(
               model=self.model,
               messages=[{"role": "user", "content": prompt}],
               temperature=0,
               **kwargs
           )
           return response.choices[0].message.content

2. **Register in** ``deployment/registry.py``
3. **Update YAML** to use ``OpenAIGateway``
4. **Set environment:** ``export OPENAI_API_KEY=sk-...``

WebSocket Support
~~~~~~~~~~~~~~~~~

.. code-block:: python

   from fastapi import FastAPI, WebSocket
   from agent_framework import BaseProgressHandler

   class WebSocketProgressHandler(BaseProgressHandler):
       def __init__(self, ws: WebSocket):
           self.ws = ws
       
       async def on_event(self, event_name: str, data: dict) -> None:
           await self.ws.send_json({"event": event_name, "data": data})

   @app.websocket("/ws/agent")
   async def agent_websocket(websocket: WebSocket):
       await websocket.accept()
       request = await websocket.receive_json()
       
       agent = AgentFactory.create_from_yaml(request["config"])
       progress = WebSocketProgressHandler(websocket)
       
       result = await agent.run(request["task"], progress_handler=progress)
       await websocket.send_json({"result": result})

Further Reading
---------------

For comprehensive documentation, see:

* :doc:`v2_features` - New capabilities in v2.0
* :doc:`execution_framework` - Runtime architecture and APIs
* :doc:`deployment_layer` - Declarative YAML and factory
* :doc:`structured_final_response` - Structured outputs and UI operations
* :doc:`creating_a_custom_tool` - Build your own tools
* :doc:`defining_agents_with_yaml` - YAML configuration reference

Example Commands
----------------

**Add Relationships:**

* "Create a relationship between 'ORDERS'[CustomerId] and 'CUSTOMERS'[Id]"
* "Link 'SALES'[ProductId] to 'PRODUCTS'[Id] with ManyToOne cardinality"
* "Add active relationship from 'TRANSACTIONS'[UserId] to 'USERS'[Id]"

**Update Relationships:**

* "Deactivate relationship id: abc123"
* "Change relationship xyz789 to use bothDirections filtering"
* "Update relationship abc123 cardinality to ManyToMany"

Testing
-------

.. code-block:: bash

   # Unit tests
   pytest tests/test_add_relationship_tool.py -v

   # Integration test
   uvicorn tests.simple_app:app &
   curl -X POST http://127.0.0.1:8000/run \
     -H 'Content-Type: application/json' \
     -d '{"task":"Add relationship","config_path":"configs/agents/schema_editor_router.yaml"}'

Supersedes
----------
- external Markdown notes; this page is the canonical reference
