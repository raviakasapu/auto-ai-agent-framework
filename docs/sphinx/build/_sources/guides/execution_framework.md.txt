# Execution Framework

Pure runtime library for building and running agents. YAML-agnostic by design.

Core abstractions: `agent_framework/base.py`
- Planner: `BasePlanner.plan(task, history) -> Action | List[Action] | FinalResponse`
- Tool: `BaseTool`
  - `name`, `description`
  - `args_schema: Type[pydantic.BaseModel]`
  - `output_schema: Optional[Type[pydantic.BaseModel]]`
  - `execute(**kwargs) -> Any` (args validated by the Agent)
- Memory: `BaseMemory.add/get_history`
- Prompt Manager: `BasePromptManager.generate_prompt(...)`
- Inference Gateway: `BaseInferenceGateway.invoke(prompt)`
- Event Subscriber: `BaseEventSubscriber.handle_event(name, data)`
- Progress Handler: `BaseProgressHandler.on_event(name, data)` (async)
- Data: `Action(tool_name, tool_args)`, `FinalResponse(operation, payload, human_readable_summary)`

Agent orchestrator: `agent_framework/core/agent.py`
- Async `run(task, progress_handler=None)` drives the plan→act→observe loop
- Publishes events: `agent_start`, `action_planned`, `action_executed`, `agent_end`, `error`
- Validates tool args via the tool `args_schema` and passes normalized kwargs to `execute`
- Executes multiple actions in parallel when a planner returns `List[Action]`
- Records steps in `memory` (task, action, observation, final)
- Safety: enforces planner `max_iterations` and detects stagnation (see Runtime & Stagnation)

Manager agent: `agent_framework/core/manager_v2.py`
- Planner‑driven delegation to named workers (`Action(tool_name=<worker_key>)`)
- Emits `manager_start`, `delegation_planned`, `delegation_chosen`, `delegation_executed`, `manager_end`
- Can synthesize worker results via an optional `synthesis_gateway`

Events & Observability: `agent_framework/core/events.py`, `agent_framework/observability/subscribers.py`
- `EventBus` with `subscribe()` and `publish()`
- `LoggingSubscriber` prints structured events with configurable levels
- `LangfuseSubscriber` and `PhoenixSubscriber` (OpenTelemetry) for external tracing

Built-in components: `agent_framework/components/`
- Planners: `StaticPlanner`, `SingleActionPlanner`, `LLMRouterPlanner`, `StrategicPlanner`, `WorkerRouterPlanner`, `ChatPlanner`, `ReActPlanner`, `MathPlanner`
- Tools: utility set under `agent_framework.tools.utility` (calculator, math QA, Python interpreter, glob/grep, etc.)
- Memory: `InMemoryMemory`, `SharedInMemoryMemory`, `HierarchicalSharedMemory`, plus message-store backed memories

Shared Memory & Message Stores
- Shared Memory: `SharedInMemoryMemory` and `HierarchicalSharedMemory` enable context sharing across agents and managers using a common `namespace`. The `SharedStateStore` provides a process-wide, thread-safe mechanism for managing this state.
- Message Store Memory: `MessageStoreMemory` and `HierarchicalMessageStoreMemory` read messages from a persisted `BaseMessageStore`, letting implementations control storage formats.
- Request Context: A thread-local `request_context` service is available for sharing request-scoped data like `job_id` and `user_id` across the framework.
- Manager Tools: `ManagerAgent` can execute its own tools in addition to delegating tasks to workers.

Logging & diagnostics
- Shared logger: `agent_framework/logging.py`; set level via `AGENT_LOG_LEVEL` (default `INFO`)
- `LoggingSubscriber` options: `level`, `include_data`, `max_payload_chars`, `event_levels`
- Router debug: set `AGENT_LOG_ROUTER_DETAILS=true` or planner `log_details: true`

Structured Final Responses
- Planners can return `FinalResponse` to end the loop with a machine‑readable result
- See: :doc:`structured_final_response` for operation types and payload conventions

Runtime & Stagnation
- Max iterations check is enforced by `Agent.run()`
- Stagnation detection guards against repeating the same action signature
- See: :doc:`runtime_loop_stagnation`

Parallel execution
- The agent executes parallel actions with `asyncio.gather`, emitting `action_executed` per tool

Manifest generator: `agent_framework/utils/manifest_generator.py`
- Introspects an assembled Agent to emit an OpenAPI‑like manifest of tools
- Includes input `parameters` and `returns` (tool `output_schema` when provided)
