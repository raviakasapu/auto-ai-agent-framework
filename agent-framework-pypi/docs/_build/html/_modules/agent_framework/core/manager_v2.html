

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>agent_framework.core.manager_v2 &mdash; AI Agent Framework 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=938c9ccc"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            AI Agent Framework
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#from-pypi-recommended">From PyPI (Recommended)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#from-source">From Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#development-installation">Development Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#environment-setup">Environment Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#project-structure">Project Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#your-first-agent">Your First Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#create-an-agent-configuration">1. Create an Agent Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#create-the-entry-point">2. Create the Entry Point</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../getting-started.html#run-your-agent">3. Run Your Agent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting-started.html#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#single-agent-examples">Single Agent Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#calculator-agent">Calculator Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#research-agent">Research Agent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#multi-agent-system">Multi-Agent System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#manager-worker-architecture">Manager-Worker Architecture</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#manager-orchestrator">Manager (Orchestrator)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#research-worker">Research Worker</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../quickstart.html#task-worker">Task Worker</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#running-agents">Running Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#single-agent">Single Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#manager-with-workers">Manager with Workers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#testing-your-agents">Testing Your Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#e2e-tests-with-real-api">E2E Tests (with real API)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#common-patterns">Common Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#environment-variable-substitution">Environment Variable Substitution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#custom-tool-registration">Custom Tool Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../quickstart.html#adding-observability">Adding Observability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../quickstart.html#next-steps">Next Steps</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/yaml-configuration.html">YAML Configuration Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/yaml-configuration.html#configuration-schema-overview">Configuration Schema Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/yaml-configuration.html#top-level-fields">Top-Level Fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#apiversion-required"><code class="docutils literal notranslate"><span class="pre">apiVersion</span></code> (required)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#kind-required"><code class="docutils literal notranslate"><span class="pre">kind</span></code> (required)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#metadata-required"><code class="docutils literal notranslate"><span class="pre">metadata</span></code> (required)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/yaml-configuration.html#resources-section">Resources Section</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#inference-gateways"><code class="docutils literal notranslate"><span class="pre">inference_gateways</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#available-gateway-types">Available Gateway Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#openaigateway-config-options">OpenAIGateway Config Options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#tools"><code class="docutils literal notranslate"><span class="pre">tools</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#built-in-tool-types">Built-in Tool Types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#subscribers"><code class="docutils literal notranslate"><span class="pre">subscribers</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#available-subscriber-types">Available Subscriber Types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/yaml-configuration.html#spec-section">Spec Section</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#policies"><code class="docutils literal notranslate"><span class="pre">policies</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#using-presets-recommended">Using Presets (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#overriding-preset-values">Overriding Preset Values</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#full-custom-policy-configuration">Full Custom Policy Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#planner"><code class="docutils literal notranslate"><span class="pre">planner</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#reactplanner-tool-using-agents">ReActPlanner (Tool-using agents)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#workerrouterplanner-for-manageragents">WorkerRouterPlanner (For ManagerAgents)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#memory"><code class="docutils literal notranslate"><span class="pre">memory</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#id1">Using Presets (Recommended)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#override-preset-defaults">Override Preset Defaults</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../guides/yaml-configuration.html#legacy-explicit-configuration">Legacy Explicit Configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#id2"><code class="docutils literal notranslate"><span class="pre">tools</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#id3"><code class="docutils literal notranslate"><span class="pre">subscribers</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#workers-manageragent-only"><code class="docutils literal notranslate"><span class="pre">workers</span></code> (ManagerAgent only)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/yaml-configuration.html#environment-variable-substitution">Environment Variable Substitution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/yaml-configuration.html#complete-examples">Complete Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#simple-worker-agent">Simple Worker Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/yaml-configuration.html#manager-with-workers">Manager with Workers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/yaml-configuration.html#validation">Validation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/agent-types.html">Agent Types Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#agent-types-overview">Agent Types Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#agent-single-worker">Agent (Single Worker)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#configuration">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#key-components">Key Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#execution-flow">Execution Flow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#manageragent-orchestrator">ManagerAgent (Orchestrator)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#id1">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#id2">Key Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#id3">Execution Flow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#comparison">Comparison</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#when-to-use-each-type">When to Use Each Type</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#use-agent-when">Use Agent when:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#use-manageragent-when">Use ManagerAgent when:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#architecture-patterns">Architecture Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#pattern-1-single-agent">Pattern 1: Single Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#pattern-2-manager-with-workers">Pattern 2: Manager with Workers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#pattern-3-shared-memory-team">Pattern 3: Shared Memory Team</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#complete-examples">Complete Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#standalone-calculator-agent">Standalone Calculator Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/agent-types.html#multi-worker-system">Multi-Worker System</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/agent-types.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/memory-presets.html">Memory Presets Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#available-presets">Available Presets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#standalone-preset">Standalone Preset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#worker-preset">Worker Preset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#manager-preset">Manager Preset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#auto-derivation-rules">Auto-Derivation Rules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#namespace">Namespace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#agent-key">Agent Key</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#subordinates-manager-only">Subordinates (Manager only)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#override-preset-defaults">Override Preset Defaults</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#memory-type-reference">Memory Type Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#inmemorymemory-standalone">InMemoryMemory (standalone)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#sharedinmemorymemory-worker">SharedInMemoryMemory (worker)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#hierarchicalsharedmemory-manager">HierarchicalSharedMemory (manager)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#complete-examples">Complete Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#standalone-agent">Standalone Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#worker-in-team">Worker in Team</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/memory-presets.html#manager-with-workers">Manager with Workers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#programmatic-usage">Programmatic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/memory-presets.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/policy-presets.html">Policy Presets Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#available-presets">Available Presets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#simple-preset">Simple Preset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#manager-with-followups-preset">Manager with Followups Preset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#with-hitl-preset">With HITL Preset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#with-checkpoints-preset">With Checkpoints Preset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#overriding-preset-values">Overriding Preset Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#policy-types-reference">Policy Types Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#defaultcompletiondetector">DefaultCompletionDetector</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#defaultterminationpolicy">DefaultTerminationPolicy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#defaultlooppreventionpolicy">DefaultLoopPreventionPolicy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#defaulthitlpolicy">DefaultHITLPolicy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#defaultcheckpointpolicy">DefaultCheckpointPolicy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#defaultfollowuppolicy">DefaultFollowUpPolicy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#complete-examples">Complete Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#worker-with-custom-termination">Worker with Custom Termination</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#manager-with-follow-ups">Manager with Follow-ups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/policy-presets.html#agent-with-human-approval">Agent with Human Approval</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#programmatic-usage">Programmatic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/policy-presets.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/tools.html">Tools Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#built-in-tools">Built-in Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#calculatortool">CalculatorTool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#mocksearchtool">MockSearchTool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#notetakertool">NoteTakerTool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#taskmanagertool">TaskManagerTool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#listtaskstool">ListTasksTool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#completetasktool">CompleteTaskTool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#weatherlookuptool">WeatherLookupTool</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#creating-custom-tools">Creating Custom Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#basic-tool-structure">Basic Tool Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#registering-custom-tools">Registering Custom Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#using-in-yaml">Using in YAML</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#tool-configuration">Tool Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#config-options">Config Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#tool-patterns">Tool Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#read-only-tools">Read-Only Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#write-tools">Write Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#composite-tools">Composite Tools</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#error-handling">Error Handling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#tool-errors">Tool Errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#validation">Validation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#complete-example">Complete Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#custom-api-tool">Custom API Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#registry-entry">Registry Entry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/tools.html#yaml-configuration">YAML Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/tools.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../guides/planners.html">Planners Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#available-planners">Available Planners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#reactplanner">ReActPlanner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#configuration">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#config-options">Config Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#how-it-works">How It Works</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#function-calling-mode">Function Calling Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#workerrouterplanner">WorkerRouterPlanner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#id1">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#id2">Config Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#id3">How It Works</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#routing-response-format">Routing Response Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#id4">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#inference-gateways">Inference Gateways</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#openaigateway">OpenAIGateway</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#anthropicgateway">AnthropicGateway</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#mockgateway">MockGateway</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#system-prompts">System Prompts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#best-practices">Best Practices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#reactplanner-prompt-template">ReActPlanner Prompt Template</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#workerrouterplanner-prompt-template">WorkerRouterPlanner Prompt Template</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#advanced-patterns">Advanced Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#chain-of-thought">Chain of Thought</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#few-shot-examples">Few-Shot Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#safety-guardrails">Safety Guardrails</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#complete-examples">Complete Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#research-agent-with-reactplanner">Research Agent with ReActPlanner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../guides/planners.html#multi-domain-manager">Multi-Domain Manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../guides/planners.html#id5">Best Practices</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/single-agent.html">Single Agent Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/single-agent.html#calculator-agent">Calculator Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#configuration">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/single-agent.html#research-agent">Research Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#id1">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#id2">Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/single-agent.html#task-management-agent">Task Management Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#id3">Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#id4">Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/single-agent.html#weather-agent">Weather Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#id5">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/single-agent.html#agent-with-observability">Agent with Observability</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#id6">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/single-agent.html#agent-with-custom-termination">Agent with Custom Termination</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#id7">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/single-agent.html#testing-single-agents">Testing Single Agents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#unit-test-example">Unit Test Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/single-agent.html#e2e-test-example">E2E Test Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/multi-agent.html">Multi-Agent Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multi-agent.html#basic-manager-worker-system">Basic Manager-Worker System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#orchestrator-configuration">Orchestrator Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#research-worker-configuration">Research Worker Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#task-worker-configuration">Task Worker Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multi-agent.html#three-worker-system">Three-Worker System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#orchestrator">Orchestrator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#calculator-worker">Calculator Worker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multi-agent.html#shared-memory-example">Shared Memory Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#orchestrator-with-shared-state">Orchestrator with Shared State</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#python-usage-with-shared-state">Python Usage with Shared State</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multi-agent.html#follow-up-phases-example">Follow-Up Phases Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#configuration">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multi-agent.html#testing-multi-agent-systems">Testing Multi-Agent Systems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#unit-test">Unit Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#integration-test">Integration Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/multi-agent.html#e2e-test">E2E Test</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/multi-agent.html#best-practices">Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/custom-tools.html">Custom Tools Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#basic-custom-tool">Basic Custom Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#tool-implementation">Tool Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#registry-registration">Registry Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#yaml-configuration">YAML Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#configurable-tool">Configurable Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id1">Tool Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id2">YAML Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#database-tool">Database Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id3">Tool Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id4">YAML Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#file-system-tool">File System Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id5">Tool Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id6">YAML Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#external-service-tool">External Service Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id7">Tool Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id8">YAML Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#composite-tool">Composite Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#id9">Tool Implementation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#testing-custom-tools">Testing Custom Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#unit-test">Unit Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/custom-tools.html#integration-test-with-agent">Integration Test with Agent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/custom-tools.html#best-practices">Best Practices</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/core.html">Core API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core.html#agent">Agent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core.html#agent_framework.core.agent.Agent"><code class="docutils literal notranslate"><span class="pre">Agent</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/core.html#agent_framework.core.agent.Agent.__init__"><code class="docutils literal notranslate"><span class="pre">Agent.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/core.html#agent_framework.core.agent.Agent.run"><code class="docutils literal notranslate"><span class="pre">Agent.run()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core.html#manageragent">ManagerAgent</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core.html#agent_framework.core.manager_v2.ManagerAgent"><code class="docutils literal notranslate"><span class="pre">ManagerAgent</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/core.html#agent_framework.core.manager_v2.ManagerAgent.__init__"><code class="docutils literal notranslate"><span class="pre">ManagerAgent.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/core.html#agent_framework.core.manager_v2.ManagerAgent.run"><code class="docutils literal notranslate"><span class="pre">ManagerAgent.run()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core.html#eventbus">EventBus</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/core.html#agent_framework.core.events.EventBus"><code class="docutils literal notranslate"><span class="pre">EventBus</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/core.html#agent_framework.core.events.EventBus.__init__"><code class="docutils literal notranslate"><span class="pre">EventBus.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/core.html#agent_framework.core.events.EventBus.subscribe"><code class="docutils literal notranslate"><span class="pre">EventBus.subscribe()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/core.html#agent_framework.core.events.EventBus.publish"><code class="docutils literal notranslate"><span class="pre">EventBus.publish()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/core.html#tool-base-class">Tool Base Class</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/components.html">Components API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/components.html#memory">Memory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#inmemorymemory">InMemoryMemory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/components.html#agent_framework.components.memory.InMemoryMemory"><code class="docutils literal notranslate"><span class="pre">InMemoryMemory</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#sharedinmemorymemory">SharedInMemoryMemory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/components.html#agent_framework.components.memory.SharedInMemoryMemory"><code class="docutils literal notranslate"><span class="pre">SharedInMemoryMemory</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#hierarchicalsharedmemory">HierarchicalSharedMemory</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/components.html#agent_framework.components.memory.HierarchicalSharedMemory"><code class="docutils literal notranslate"><span class="pre">HierarchicalSharedMemory</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#module-agent_framework.components.memory_presets">Memory Presets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/components.html#agent_framework.components.memory_presets.get_memory_preset"><code class="docutils literal notranslate"><span class="pre">get_memory_preset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/components.html#agent_framework.components.memory_presets.list_memory_presets"><code class="docutils literal notranslate"><span class="pre">list_memory_presets()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api/components.html#agent_framework.components.memory_presets.describe_preset"><code class="docutils literal notranslate"><span class="pre">describe_preset()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/components.html#planners">Planners</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#reactplanner">ReActPlanner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#workerrouterplanner">WorkerRouterPlanner</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/components.html#inference-gateways">Inference Gateways</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#openaigateway">OpenAIGateway</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#anthropicgateway">AnthropicGateway</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/components.html#mockgateway">MockGateway</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/policies.html">Policies API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/policies.html#module-agent_framework.policies.presets">Policy Presets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.presets.get_preset"><code class="docutils literal notranslate"><span class="pre">get_preset()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.presets.list_presets"><code class="docutils literal notranslate"><span class="pre">list_presets()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/policies.html#default-policies">Default Policies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#defaultcompletiondetector">DefaultCompletionDetector</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.default.DefaultCompletionDetector"><code class="docutils literal notranslate"><span class="pre">DefaultCompletionDetector</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#defaultterminationpolicy">DefaultTerminationPolicy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.default.DefaultTerminationPolicy"><code class="docutils literal notranslate"><span class="pre">DefaultTerminationPolicy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#defaultlooppreventionpolicy">DefaultLoopPreventionPolicy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.default.DefaultLoopPreventionPolicy"><code class="docutils literal notranslate"><span class="pre">DefaultLoopPreventionPolicy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#defaulthitlpolicy">DefaultHITLPolicy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.default.DefaultHITLPolicy"><code class="docutils literal notranslate"><span class="pre">DefaultHITLPolicy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#defaultcheckpointpolicy">DefaultCheckpointPolicy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.default.DefaultCheckpointPolicy"><code class="docutils literal notranslate"><span class="pre">DefaultCheckpointPolicy</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/policies.html#defaultfollowuppolicy">DefaultFollowUpPolicy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../api/policies.html#agent_framework.policies.default.DefaultFollowUpPolicy"><code class="docutils literal notranslate"><span class="pre">DefaultFollowUpPolicy</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">Testing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#test-structure">Test Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#running-tests">Running Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#all-tests">All Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#by-category">By Category</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#with-coverage">With Coverage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#unit-tests">Unit Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#example-testing-a-tool">Example: Testing a Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#example-testing-an-agent-with-mocks">Example: Testing an Agent with Mocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#example-testing-memory-presets">Example: Testing Memory Presets</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#integration-tests">Integration Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#example-agent-loop-test">Example: Agent Loop Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#example-manager-worker-integration">Example: Manager-Worker Integration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#e2e-tests">E2E Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#skip-decorator">Skip Decorator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#example-real-agent-test">Example: Real Agent Test</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#fixtures">Fixtures</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../testing.html#common-fixtures">Common Fixtures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing.html#test-coverage">Test Coverage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#development-setup">Development Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#project-structure">Project Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#code-style">Code Style</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#python-style">Python Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#formatting">Formatting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#linting">Linting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#testing">Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#running-tests">Running Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#writing-tests">Writing Tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#documentation">Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#building-docs">Building Docs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#writing-docs">Writing Docs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#pull-request-process">Pull Request Process</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#commit-messages">Commit Messages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#adding-new-components">Adding New Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#new-tool">New Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#new-policy">New Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../contributing.html#new-gateway">New Gateway</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#questions">Questions?</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">AI Agent Framework</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">agent_framework.core.manager_v2</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for agent_framework.core.manager_v2</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ManagerAgent class v2 - Policy-driven manager with configurable delegation and follow-ups.</span>

<span class="sd">This version replaces all hardcoded behavior with configurable policies.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BasePlanner</span><span class="p">,</span> <span class="n">BaseMemory</span><span class="p">,</span> <span class="n">BaseProgressHandler</span><span class="p">,</span> <span class="n">Action</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">BaseJobStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.events</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventBus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.event_payloads</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">build_action_executed_event</span><span class="p">,</span>
    <span class="n">build_action_planned_event</span><span class="p">,</span>
    <span class="n">build_delegation_event</span><span class="p">,</span>
    <span class="n">build_error_event</span><span class="p">,</span>
    <span class="n">build_manager_end_event</span><span class="p">,</span>
    <span class="n">build_manager_script_planned_event</span><span class="p">,</span>
    <span class="n">build_manager_start_event</span><span class="p">,</span>
    <span class="n">build_segment_event</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_request_context</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span> <span class="k">as</span> <span class="n">_get_ctx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..services.context_builder</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..policies.base</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CompletionDetector</span><span class="p">,</span>
    <span class="n">FollowUpPolicy</span><span class="p">,</span>
    <span class="n">LoopPreventionPolicy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..policies.default</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">DefaultCompletionDetector</span><span class="p">,</span>
    <span class="n">DefaultFollowUpPolicy</span><span class="p">,</span>
    <span class="n">DefaultLoopPreventionPolicy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.script_args</span><span class="w"> </span><span class="kn">import</span> <span class="n">normalize_script_args</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..constants</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">SYNTHESIS</span><span class="p">,</span>
    <span class="n">TASK</span><span class="p">,</span>
    <span class="n">ACTION</span><span class="p">,</span>
    <span class="n">OBSERVATION</span><span class="p">,</span>
    <span class="n">ERROR</span><span class="p">,</span>
    <span class="n">FINAL</span><span class="p">,</span>
    <span class="n">STRATEGIC_PLAN</span><span class="p">,</span>
    <span class="n">SCRIPT_PLAN</span><span class="p">,</span>
    <span class="n">DELEGATION</span><span class="p">,</span>
    <span class="n">GLOBAL_OBSERVATION</span><span class="p">,</span>
    <span class="n">DIRECTOR_CONTEXT</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>


<div class="viewcode-block" id="ManagerAgent">
<a class="viewcode-back" href="../../../api/core.html#agent_framework.core.manager_v2.ManagerAgent">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ManagerAgent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Policy-driven manager with configurable delegation and follow-ups.&quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ManagerAgent.__init__">
<a class="viewcode-back" href="../../../api/core.html#agent_framework.core.manager_v2.ManagerAgent.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">planner</span><span class="p">:</span> <span class="n">BasePlanner</span><span class="p">,</span>
        <span class="n">memory</span><span class="p">:</span> <span class="n">BaseMemory</span><span class="p">,</span>
        <span class="n">workers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">policies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>  <span class="c1"># REQUIRED - no defaults</span>
        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">BaseTool</span><span class="p">]</span> <span class="o">|</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">event_bus</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EventBus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">synthesis_gateway</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">synthesis_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">synthesizer_agent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseJobStore</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">agent_framework.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Policies are required for ManagerAgent.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate required policies</span>
        <span class="n">required_policies</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;completion&quot;</span><span class="p">,</span> <span class="s2">&quot;follow_up&quot;</span><span class="p">,</span> <span class="s2">&quot;loop_prevention&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">policy_name</span> <span class="ow">in</span> <span class="n">required_policies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">policy_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required policy &#39;</span><span class="si">{</span><span class="n">policy_name</span><span class="si">}</span><span class="s2">&#39; not provided.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Initialize components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planner</span> <span class="o">=</span> <span class="n">planner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">workers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;worker</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">w</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">workers</span><span class="p">)}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTool</span><span class="p">]</span> <span class="o">=</span> <span class="n">tools</span>
        <span class="k">elif</span> <span class="n">tools</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span> <span class="o">=</span> <span class="n">event_bus</span> <span class="ow">or</span> <span class="n">EventBus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;ManagerAgent&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="s2">&quot;A manager agent.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="ow">or</span> <span class="s2">&quot;2.0.0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_gateway</span> <span class="o">=</span> <span class="n">synthesis_gateway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_prompt</span> <span class="o">=</span> <span class="n">synthesis_prompt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_synthesis_prompt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synthesizer_agent</span> <span class="o">=</span> <span class="n">synthesizer_agent</span>  <span class="c1"># Optional separate synthesizer agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span> <span class="o">=</span> <span class="n">job_store</span>  <span class="c1"># Optional job persistence store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ContextBuilder</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Initialize policies (REQUIRED)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completion_detector</span><span class="p">:</span> <span class="n">CompletionDetector</span> <span class="o">=</span> <span class="n">policies</span><span class="p">[</span><span class="s2">&quot;completion&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">follow_up_policy</span><span class="p">:</span> <span class="n">FollowUpPolicy</span> <span class="o">=</span> <span class="n">policies</span><span class="p">[</span><span class="s2">&quot;follow_up&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop_prevention</span><span class="p">:</span> <span class="n">LoopPreventionPolicy</span> <span class="o">=</span> <span class="n">policies</span><span class="p">[</span><span class="s2">&quot;loop_prevention&quot;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_synthesis_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;You are a manager analyzing worker results to provide higher-level insights.</span>

<span class="s2">Your role:</span>
<span class="s2">1. Synthesize raw data into meaningful patterns</span>
<span class="s2">2. Identify relationships and correlations</span>
<span class="s2">3. Assess quality and completeness</span>
<span class="s2">4. Provide actionable recommendations</span>
<span class="s2">5. Reorganize information for clarity</span>

<span class="s2">Return a final_response JSON with your analysis.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ManagerAgent.run">
<a class="viewcode-back" href="../../../api/core.html#agent_framework.core.manager_v2.ManagerAgent.run">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute task with policy-driven behavior control.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">TASK</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">})</span>
        
        <span class="c1"># Get job_id from context (implementation-specific)</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;JOB_ID&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;job_id&quot;</span><span class="p">)</span>
            <span class="c1"># Create job in store if job_store is provided</span>
            <span class="k">if</span> <span class="n">job_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="o">.</span><span class="n">create_job</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c1"># If strategic plan provided, add to memory for context</span>
        <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">STRATEGIC_PLAN</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">strategic_plan</span><span class="p">})</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="n">strategic_plan</span><span class="p">)</span>
            <span class="c1"># Persist plan in job store if provided</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;orchestrator&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="o">.</span><span class="n">update_orchestrator_plan</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="o">.</span><span class="n">update_manager_plan</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">ContextBuilder</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span> <span class="o">=</span> <span class="n">builder</span>

        <span class="n">context_text</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">manifest_text</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">builder</span><span class="p">:</span>
            <span class="n">worker_descriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_describe_workers</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_orchestrator</span><span class="p">():</span>
                <span class="n">context_text</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build_orchestrator_context</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">worker_descriptions</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">manifest_text</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_schema_manifest</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">manifest_text</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">manifest_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="n">MANAGER_MANIFEST_LIMIT</span><span class="p">:</span>
                        <span class="n">manifest_text</span> <span class="o">=</span> <span class="n">manifest_text</span><span class="p">[:</span> <span class="n">builder</span><span class="o">.</span><span class="n">MANAGER_MANIFEST_LIMIT</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">manifest_text</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context_text</span><span class="p">,</span> <span class="n">manifest_summary</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build_manager_context</span><span class="p">(</span>
                    <span class="n">context</span> <span class="ow">or</span> <span class="n">task</span><span class="p">,</span>
                    <span class="n">worker_descriptions</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">manifest_text</span> <span class="o">=</span> <span class="n">manifest_summary</span> <span class="ow">or</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_schema_manifest</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">context_text</span> <span class="o">=</span> <span class="n">context</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_context</span><span class="p">(</span><span class="n">context_text</span><span class="p">,</span> <span class="n">manifest_text</span><span class="p">)</span>
        <span class="n">plan_summary</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">manager_tools</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_orchestrator</span><span class="p">():</span>
            <span class="n">plan_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_plan_for_events</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">)</span>
            <span class="n">manager_tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_describe_manager_tools</span><span class="p">()</span>
        <span class="n">start_data</span> <span class="o">=</span> <span class="n">build_manager_start_event</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
            <span class="n">workers</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">has_plan</span><span class="o">=</span><span class="n">strategic_plan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">context_text</span><span class="p">,</span>
            <span class="n">orchestrator_plan</span><span class="o">=</span><span class="n">plan_summary</span><span class="p">,</span>
            <span class="n">manager_tools</span><span class="o">=</span><span class="n">manager_tools</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;manager_start&quot;</span><span class="p">,</span> <span class="n">start_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;manager_start&quot;</span><span class="p">,</span> <span class="n">start_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No workers available for delegation&quot;</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>
        
        <span class="c1"># Build context for policies</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;JOB_ID&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;job_id&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">policy_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
            <span class="s2">&quot;manager_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
            <span class="s2">&quot;strategic_plan&quot;</span><span class="p">:</span> <span class="n">strategic_plan</span>
        <span class="p">}</span>

        <span class="c1"># Ask manager&#39;s planner to decide</span>
        <span class="n">decision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planner</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">get_history</span><span class="p">())</span>
        
        <span class="c1"># Check if decision includes strategic plan from director</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decision</span><span class="p">,</span> <span class="n">Action</span><span class="p">):</span>
            <span class="n">worker_strategic_plan</span> <span class="o">=</span> <span class="n">decision</span><span class="o">.</span><span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
            <span class="n">worker_context</span> <span class="o">=</span> <span class="n">decision</span><span class="o">.</span><span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_task&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">worker_strategic_plan</span><span class="p">:</span>
                <span class="n">strategic_plan</span> <span class="o">=</span> <span class="n">worker_strategic_plan</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">worker_context</span> <span class="ow">or</span> <span class="n">task</span>

        <span class="c1"># Handle FinalResponse from planner</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decision</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_final_response</span><span class="p">(</span><span class="n">decision</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

        <span class="c1"># Handle parallel delegation</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decision</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_parallel_delegation</span><span class="p">(</span>
                <span class="n">decision</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">,</span> <span class="n">strategic_plan</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">policy_context</span>
            <span class="p">)</span>

        <span class="c1"># Handle single delegation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decision</span><span class="p">,</span> <span class="n">Action</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
                <span class="s2">&quot;Planner did not return an actionable decision&quot;</span><span class="p">,</span>
                <span class="n">progress_handler</span>
            <span class="p">)</span>

        <span class="n">action_key</span> <span class="o">=</span> <span class="n">decision</span><span class="o">.</span><span class="n">tool_name</span>

        <span class="c1"># Check if it&#39;s a worker</span>
        <span class="k">if</span> <span class="n">action_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_with_follow_ups</span><span class="p">(</span>
                <span class="n">action_key</span><span class="p">,</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">decision</span><span class="o">.</span><span class="n">tool_args</span><span class="p">,</span>
                <span class="n">strategic_plan</span><span class="p">,</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="n">policy_context</span>
            <span class="p">)</span>

        <span class="c1"># Check if it&#39;s a manager tool</span>
        <span class="k">if</span> <span class="n">action_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_manager_tool</span><span class="p">(</span><span class="n">decision</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

        <span class="c1"># Fallback: invalid action</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid action: &#39;</span><span class="si">{</span><span class="n">action_key</span><span class="si">}</span><span class="s2">&#39; is not a known worker or manager tool.&quot;</span><span class="p">,</span>
            <span class="n">progress_handler</span>
        <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_delegate_with_follow_ups</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">],</span>
        <span class="n">tool_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">policy_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delegate to worker with configurable follow-ups.&quot;&quot;&quot;</span>
        
        <span class="n">script_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">script_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">maybe_script</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">maybe_script</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">script_steps</span> <span class="o">=</span> <span class="n">maybe_script</span>
            <span class="n">script_metadata</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script_metadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">script_steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_script_plan</span><span class="p">(</span>
                <span class="n">script_steps</span><span class="p">,</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">script_metadata</span><span class="p">,</span>
                <span class="n">strategic_plan</span><span class="p">,</span>
                <span class="n">context</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Fallback: try to get strategic plan from tool_args if not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strategic_plan</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">strategic_plan</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
        
        <span class="c1"># Extract phases from strategic plan</span>
        <span class="c1"># Supports both:</span>
        <span class="c1"># - Orchestrator phases: {&quot;plan&quot;: {&quot;phases&quot;: [...]}}</span>
        <span class="c1"># - Manager local steps: {&quot;phases&quot;: [...]} (from StrategicDecomposerPlanner)</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_phases</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">)</span>
        
        <span class="c1"># CRITICAL: If phases/steps exist, execute ALL sequentially in order</span>
        <span class="c1"># Each phase/step gets: orchestrator phase goals + previous step output</span>
        <span class="c1"># Ignore primary_worker override - use each phase&#39;s assigned worker and goals</span>
        <span class="k">if</span> <span class="n">phases</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_phases_sequentially</span><span class="p">(</span>
                <span class="n">phases</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">,</span> <span class="n">tool_args</span><span class="p">,</span> <span class="n">strategic_plan</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">policy_context</span>
            <span class="p">)</span>

        <span class="c1"># Execute primary worker</span>
        <span class="n">primary_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_to_worker_parallel</span><span class="p">(</span>
            <span class="n">worker_key</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">,</span> <span class="n">tool_args</span><span class="p">,</span> <span class="n">strategic_plan</span><span class="p">,</span> <span class="n">context</span>
        <span class="p">)</span>
        
        <span class="c1"># Check for approval request</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primary_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">primary_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;await_approval&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_approval_request</span><span class="p">(</span><span class="n">primary_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>
        
        <span class="c1"># Check completion before follow-ups</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion_detector</span><span class="o">.</span><span class="n">is_complete</span><span class="p">(</span><span class="n">primary_result</span><span class="p">,</span> <span class="p">[],</span> <span class="n">policy_context</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Task completed in primary worker. Skipping follow-ups.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">primary_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>
        
        <span class="c1"># Check if follow-ups should proceed</span>
        <span class="n">completed_phases</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Primary phase completed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_up_policy</span><span class="o">.</span><span class="n">should_follow_up</span><span class="p">(</span>
            <span class="n">primary_result</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">completed_phases</span><span class="p">,</span> <span class="n">policy_context</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">primary_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>
        
        <span class="c1"># Execute follow-up phases</span>
        <span class="n">workers_run</span> <span class="o">=</span> <span class="p">[</span><span class="n">worker_key</span><span class="p">]</span>
        <span class="n">results_run</span> <span class="o">=</span> <span class="p">[</span><span class="n">primary_result</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># Skip first phase (already done)</span>
            <span class="c1"># Check if we should continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">follow_up_policy</span><span class="o">.</span><span class="n">should_follow_up</span><span class="p">(</span>
                <span class="n">results_run</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">phases</span><span class="p">,</span> <span class="n">completed_phases</span><span class="p">,</span> <span class="n">policy_context</span>
            <span class="p">):</span>
                <span class="k">break</span>
            
            <span class="c1"># Check completion after each phase</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">completion_detector</span><span class="o">.</span><span class="n">is_complete</span><span class="p">(</span>
                <span class="n">results_run</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[],</span> <span class="n">policy_context</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Task completed in follow-up phase. Stopping.&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            
            <span class="n">phase_worker</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Execute phase</span>
            <span class="n">phase_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_to_worker_parallel</span><span class="p">(</span>
                <span class="n">phase_worker</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">,</span> <span class="p">{},</span> <span class="n">strategic_plan</span><span class="p">,</span> <span class="n">context</span>
            <span class="p">)</span>
            
            <span class="n">workers_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_worker</span><span class="p">)</span>
            <span class="n">results_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_result</span><span class="p">)</span>
            <span class="n">completed_phases</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Check for approval</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">phase_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;await_approval&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_approval_request</span><span class="p">(</span><span class="n">phase_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>
        
        <span class="c1"># Aggregate results</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_parallel_manager_results</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{})</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">workers_run</span><span class="p">],</span>
            <span class="n">results_run</span>
        <span class="p">)</span>
        
        <span class="c1"># Optional synthesis</span>
        <span class="n">final_result</span> <span class="o">=</span> <span class="n">aggregated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_gateway</span><span class="p">:</span>
            <span class="n">synthesized</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_result</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="n">aggregated</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synthesized</span><span class="p">:</span>
                <span class="n">final_result</span> <span class="o">=</span> <span class="n">synthesized</span>
        
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">final_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_phases_sequentially</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">phases</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">],</span>
        <span class="n">tool_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">policy_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute all phases/steps sequentially in order, using each phase&#39;s/step&#39;s worker and goals.</span>
<span class="sd">        </span>
<span class="sd">        This ensures orchestrator always runs phases sequentially as planned, and managers</span>
<span class="sd">        run steps sequentially as planned, regardless of primary_worker override.</span>
<span class="sd">        Each phase/step executes with its assigned worker and goals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workers_run</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results_run</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Determine if this is manager steps (local plan) or orchestrator phases</span>
        <span class="c1"># Orchestrator plans come from StrategicPlanner and are passed directly as plan_data (flat structure)</span>
        <span class="c1"># Manager plans come from StrategicDecomposerPlanner and also have flat structure</span>
        <span class="c1"># Check manager name to distinguish: orchestrator runs phases, managers run steps</span>
        <span class="n">is_manager_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;orchestrator&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">term</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span> <span class="k">if</span> <span class="n">is_manager_steps</span> <span class="k">else</span> <span class="s2">&quot;phase&quot;</span>
        <span class="n">term_capitalized</span> <span class="o">=</span> <span class="s2">&quot;Step&quot;</span> <span class="k">if</span> <span class="n">is_manager_steps</span> <span class="k">else</span> <span class="s2">&quot;Phase&quot;</span>
        
        <span class="c1"># Execute each phase/step sequentially in order</span>
        <span class="n">previous_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">total_segments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
            <span class="n">phase_worker</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_worker</span> <span class="ow">or</span> <span class="n">phase_worker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unnamed&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;: worker &#39;</span><span class="si">{</span><span class="n">phase_worker</span><span class="si">}</span><span class="s2">&#39; not found in workers&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Extract task from phase/step goals, fallback to original task</span>
            <span class="n">phase_task</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">phase_task</span><span class="p">:</span>
                <span class="n">phase_task</span> <span class="o">=</span> <span class="n">task</span>
            
            <span class="c1"># For subsequent phases/steps, combine orchestrator phase/step input with previous step output</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">previous_result</span><span class="p">:</span>
                <span class="n">previous_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_previous_result</span><span class="p">(</span><span class="n">previous_result</span><span class="p">)</span>
                <span class="n">phase_task</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_task</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="s2">Previous </span><span class="si">{</span><span class="n">term_capitalized</span><span class="si">}</span><span class="s2"> Output:</span><span class="se">\n</span><span class="si">{</span><span class="n">previous_summary</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">phase_name</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">term_capitalized</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">&#39; -&gt; worker: </span><span class="si">{</span><span class="n">phase_worker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_manager_steps</span><span class="p">:</span>
                <span class="n">step_item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">phase_name</span><span class="p">,</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">phase_worker</span><span class="p">,</span>
                    <span class="s2">&quot;tool_name&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_name&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;goals&quot;</span><span class="p">:</span> <span class="n">phase_task</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">start_event</span> <span class="o">=</span> <span class="n">build_segment_event</span><span class="p">(</span>
                    <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
                    <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                    <span class="n">index_key</span><span class="o">=</span><span class="s2">&quot;step_index&quot;</span><span class="p">,</span>
                    <span class="n">total_key</span><span class="o">=</span><span class="s2">&quot;total_steps&quot;</span><span class="p">,</span>
                    <span class="n">item_key</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">total_segments</span><span class="p">,</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">step_item</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">start_event_name</span> <span class="o">=</span> <span class="s2">&quot;manager_step_start&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase_item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">phase_name</span><span class="p">,</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">phase_worker</span><span class="p">,</span>
                    <span class="s2">&quot;goals&quot;</span><span class="p">:</span> <span class="n">phase_task</span><span class="p">,</span>
                    <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">:</span> <span class="n">strategic_plan</span><span class="p">}</span> <span class="k">if</span> <span class="n">strategic_plan</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">start_event</span> <span class="o">=</span> <span class="n">build_segment_event</span><span class="p">(</span>
                    <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
                    <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                    <span class="n">index_key</span><span class="o">=</span><span class="s2">&quot;phase_index&quot;</span><span class="p">,</span>
                    <span class="n">total_key</span><span class="o">=</span><span class="s2">&quot;total_phases&quot;</span><span class="p">,</span>
                    <span class="n">item_key</span><span class="o">=</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">total_segments</span><span class="p">,</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">phase_item</span><span class="p">,</span>
                    <span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">start_event_name</span> <span class="o">=</span> <span class="s2">&quot;orchestrator_phase_start&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">start_event_name</span><span class="p">,</span> <span class="n">start_event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">start_event_name</span><span class="p">,</span> <span class="n">start_event</span><span class="p">)</span>
            
            <span class="c1"># Execute phase/step with phase-specific task</span>
            <span class="c1"># Store phase/step index in request context:</span>
            <span class="c1"># - Orchestrator phases: Manager&#39;s StrategicDecomposerPlanner needs to select correct orchestrator phase</span>
            <span class="c1"># - Manager steps: Workers might need to know which step they&#39;re executing (for nested ManagerAgents or context)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_request_context</span>
            <span class="k">if</span> <span class="n">is_manager_steps</span><span class="p">:</span>
                <span class="c1"># Manager steps: Store as manager_step_index</span>
                <span class="n">update_request_context</span><span class="p">(</span>
                    <span class="n">manager_step_index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>  <span class="c1"># 0-based index</span>
                    <span class="n">manager_total_steps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Orchestrator phases: Store as orchestrator_phase_index</span>
                <span class="n">update_request_context</span><span class="p">(</span>
                    <span class="n">orchestrator_phase_index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>  <span class="c1"># 0-based index</span>
                    <span class="n">orchestrator_total_phases</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
                <span class="p">)</span>
            
            <span class="c1"># Pass tool_args only to first phase/step</span>
            <span class="n">phase_tool_args</span> <span class="o">=</span> <span class="n">tool_args</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{}</span>
            
            <span class="c1"># Create worker-specific strategic plan containing only the current step</span>
            <span class="c1"># Workers should not see all orchestrator phases or all manager steps - only their specific task</span>
            <span class="c1"># Update request context with worker-specific plan so workers&#39; planners see only their task</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_request_context</span>
            <span class="k">if</span> <span class="n">is_manager_steps</span><span class="p">:</span>
                <span class="c1"># Manager steps: Create a plan with only the current step</span>
                <span class="n">worker_strategic_plan</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;primary_worker&quot;</span><span class="p">:</span> <span class="n">phase_worker</span><span class="p">,</span>
                    <span class="s2">&quot;task_type&quot;</span><span class="p">:</span> <span class="s2">&quot;execution&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;phases&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">phase_worker</span><span class="p">,</span>
                            <span class="s2">&quot;goals&quot;</span><span class="p">:</span> <span class="n">phase_task</span><span class="p">,</span>
                            <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;rationale&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Executing manager step </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unnamed&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">}</span>
                <span class="c1"># Update context with worker-specific plan (will be restored after delegation)</span>
                <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="n">worker_strategic_plan</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Orchestrator phases: Workers shouldn&#39;t receive orchestrator plan</span>
                <span class="c1"># Clear strategic_plan from context for workers (they only need the task)</span>
                <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">worker_strategic_plan</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">phase_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_to_worker_parallel</span><span class="p">(</span>
                    <span class="n">phase_worker</span><span class="p">,</span> <span class="n">phase_task</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">,</span> 
                    <span class="n">phase_tool_args</span><span class="p">,</span>
                    <span class="n">worker_strategic_plan</span><span class="p">,</span> <span class="n">context</span>  <span class="c1"># Pass worker-specific plan, not full orchestrator plan</span>
                <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Restore original strategic_plan in context after delegation</span>
                <span class="c1"># This ensures subsequent steps/workers don&#39;t see previous worker&#39;s plan</span>
                <span class="k">if</span> <span class="n">is_manager_steps</span><span class="p">:</span>
                    <span class="c1"># Restore manager&#39;s local plan (if any)</span>
                    <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
                        <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="n">strategic_plan</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Restore orchestrator plan for next phase</span>
                    <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
                        <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="n">strategic_plan</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            
            <span class="n">workers_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_worker</span><span class="p">)</span>
            <span class="n">results_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_result</span><span class="p">)</span>
            
            <span class="n">result_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_status</span><span class="p">(</span><span class="n">phase_result</span><span class="p">)</span>
            <span class="n">result_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_result</span><span class="p">(</span><span class="n">phase_result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_manager_steps</span><span class="p">:</span>
                <span class="n">step_item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">phase_name</span><span class="p">,</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">phase_worker</span><span class="p">,</span>
                    <span class="s2">&quot;tool_name&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_name&quot;</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">end_event</span> <span class="o">=</span> <span class="n">build_segment_event</span><span class="p">(</span>
                    <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
                    <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                    <span class="n">index_key</span><span class="o">=</span><span class="s2">&quot;step_index&quot;</span><span class="p">,</span>
                    <span class="n">total_key</span><span class="o">=</span><span class="s2">&quot;total_steps&quot;</span><span class="p">,</span>
                    <span class="n">item_key</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">total_segments</span><span class="p">,</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">step_item</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">=</span><span class="n">phase_result</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">result_status</span><span class="p">,</span>
                    <span class="n">result_summary</span><span class="o">=</span><span class="n">result_summary</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">end_event_name</span> <span class="o">=</span> <span class="s2">&quot;manager_step_end&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase_item</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">phase_name</span><span class="p">,</span>
                    <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">phase_worker</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">end_event</span> <span class="o">=</span> <span class="n">build_segment_event</span><span class="p">(</span>
                    <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
                    <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                    <span class="n">index_key</span><span class="o">=</span><span class="s2">&quot;phase_index&quot;</span><span class="p">,</span>
                    <span class="n">total_key</span><span class="o">=</span><span class="s2">&quot;total_phases&quot;</span><span class="p">,</span>
                    <span class="n">item_key</span><span class="o">=</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">total_segments</span><span class="p">,</span>
                    <span class="n">item</span><span class="o">=</span><span class="n">phase_item</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">=</span><span class="n">phase_result</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">result_status</span><span class="p">,</span>
                    <span class="n">result_summary</span><span class="o">=</span><span class="n">result_summary</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">end_event_name</span> <span class="o">=</span> <span class="s2">&quot;orchestrator_phase_end&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">end_event_name</span><span class="p">,</span> <span class="n">end_event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">end_event_name</span><span class="p">,</span> <span class="n">end_event</span><span class="p">)</span>

            <span class="c1"># Store result for next phase/step</span>
            <span class="n">previous_result</span> <span class="o">=</span> <span class="n">phase_result</span>
            
            <span class="c1"># Check for approval request</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">phase_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;await_approval&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_approval_request</span><span class="p">(</span><span class="n">phase_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>
            
            <span class="c1"># For sequential phases/steps, continue to next phase (don&#39;t stop early)</span>
            <span class="c1"># Only stop if we&#39;ve executed all phases/steps</span>
        
        <span class="c1"># Clear phase/step index from context after all phases/steps complete</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">update_request_context</span>
        <span class="k">if</span> <span class="n">is_manager_steps</span><span class="p">:</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">manager_step_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager_total_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">orchestrator_phase_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orchestrator_total_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Aggregate all phase results</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_parallel_manager_results</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Action</span><span class="p">(</span><span class="n">tool_name</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">tool_args</span><span class="o">=</span><span class="p">{})</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">workers_run</span><span class="p">],</span>
            <span class="n">results_run</span>
        <span class="p">)</span>
        
        <span class="c1"># Invoke synthesizer agent (if configured) to create detailed summaries for next manager</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesizer_agent</span><span class="p">:</span>
            <span class="n">synthesized_output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_synthesizer_agent</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">workers_run</span><span class="p">,</span> <span class="n">results_run</span><span class="p">,</span> <span class="n">strategic_plan</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">progress_handler</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">synthesized_output</span><span class="p">:</span>
                <span class="c1"># Store synthesized output in shared memory for next manager access</span>
                <span class="c1"># Add phase_id metadata if available for hierarchical filtering</span>
                <span class="n">phase_index</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;orchestrator_phase_index&quot;</span><span class="p">)</span>
                <span class="n">synthesis_entry</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">SYNTHESIS</span><span class="p">,</span>
                    <span class="s2">&quot;from_manager&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">synthesized_output</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="kc">None</span>  <span class="c1"># Will be set by store</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">phase_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">synthesis_entry</span><span class="p">[</span><span class="s2">&quot;phase_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_index</span>
                <span class="n">add_global_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;add_global&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">add_global_method</span><span class="p">):</span>
                    <span class="n">add_global_method</span><span class="p">(</span><span class="n">synthesis_entry</span><span class="p">)</span>
                <span class="n">synthesizer_final</span> <span class="o">=</span> <span class="n">synthesized_output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;full_result&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">synthesizer_final</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">):</span>
                    <span class="n">synthesizer_final</span> <span class="o">=</span> <span class="n">synthesizer_final</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">synthesizer_final</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">synthesizer_final</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>
        
        <span class="c1"># Optional synthesis (existing gateway-based synthesis for user-facing response)</span>
        <span class="n">final_result</span> <span class="o">=</span> <span class="n">aggregated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_gateway</span><span class="p">:</span>
            <span class="n">synthesized</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_result</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="n">aggregated</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synthesized</span><span class="p">:</span>
                <span class="n">final_result</span> <span class="o">=</span> <span class="n">synthesized</span>
        
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">final_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_previous_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Format previous phase result for passing to next phase.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="c1"># Extract human-readable summary if available</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
            <span class="n">formatted</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">formatted</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Include operation and payload info if available</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation: </span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Include key payload information</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Try to extract meaningful information from payload</span>
            <span class="k">if</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Message: </span><span class="si">{</span><span class="n">payload</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                    <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">formatted</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Fallback: format the whole result if no structured info</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">formatted</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">formatted</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">formatted</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">formatted</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_result_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;await_approval&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;pending&quot;</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_message&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;failed&quot;</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;failed&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;success&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_script_plan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">script_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">],</span>
        <span class="n">script_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a manager-level script by chunking steps by worker and running sequentially.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">script_steps</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
                <span class="s2">&quot;Script plan contained no steps to execute&quot;</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">validation_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_script_steps</span><span class="p">(</span><span class="n">script_steps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation_error</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span><span class="n">validation_error</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

        <span class="n">goal</span> <span class="o">=</span> <span class="n">script_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goal&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">({</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">SCRIPT_PLAN</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;goal&quot;</span><span class="p">:</span> <span class="n">goal</span><span class="p">,</span>
                <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="n">script_steps</span><span class="p">,</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">script_metadata</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">})</span>

        <span class="n">script_event_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">script_metadata</span><span class="p">)</span>
        <span class="n">script_event_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;goal&quot;</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span>
        <span class="n">script_event_metadata</span><span class="p">[</span><span class="s2">&quot;total_steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">script_steps</span><span class="p">)</span>
        <span class="n">planned_event</span> <span class="o">=</span> <span class="n">build_manager_script_planned_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">script_steps</span><span class="o">=</span><span class="n">script_steps</span><span class="p">,</span>
            <span class="n">script_metadata</span><span class="o">=</span><span class="n">script_event_metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;manager_script_planned&quot;</span><span class="p">,</span> <span class="n">planned_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;manager_script_planned&quot;</span><span class="p">,</span> <span class="n">planned_event</span><span class="p">)</span>

        <span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_script_segments</span><span class="p">(</span><span class="n">script_steps</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">segments</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
                <span class="s2">&quot;Script plan did not map to any known workers&quot;</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">workers_run</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results_run</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aggregate_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">overall_status</span> <span class="o">=</span> <span class="s2">&quot;SUCCESS&quot;</span>

        <span class="k">for</span> <span class="n">seg_idx</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">segments</span><span class="p">):</span>
            <span class="n">worker_key</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker_key</span> <span class="ow">or</span> <span class="n">worker_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Script step targets unknown worker &#39;</span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="n">progress_handler</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_key</span><span class="p">]</span>
            <span class="n">segment_task</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">goal</span>
            <span class="n">segment_mode</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;direct&quot;</span>
            <span class="n">segment_metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">script_metadata</span><span class="p">,</span>
                <span class="s2">&quot;segment_index&quot;</span><span class="p">:</span> <span class="n">seg_idx</span><span class="p">,</span>
                <span class="s2">&quot;total_segments&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">),</span>
                <span class="s2">&quot;execution_mode&quot;</span><span class="p">:</span> <span class="n">segment_mode</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">segment_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;script_metadata&quot;</span><span class="p">:</span> <span class="n">segment_metadata</span><span class="p">,</span>
                <span class="s2">&quot;original_task&quot;</span><span class="p">:</span> <span class="n">segment_task</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">segment_mode</span> <span class="o">==</span> <span class="s2">&quot;guided&quot;</span><span class="p">:</span>
                <span class="n">segment_args</span><span class="p">[</span><span class="s2">&quot;suggested_plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">segment_args</span><span class="p">[</span><span class="s2">&quot;script&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>

            <span class="n">chunk_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_to_worker_parallel</span><span class="p">(</span>
                <span class="n">worker_key</span><span class="p">,</span>
                <span class="n">segment_task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">segment_args</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">context</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">chunk_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;await_approval&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_approval_request</span><span class="p">(</span><span class="n">chunk_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

            <span class="n">workers_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker_key</span><span class="p">)</span>
            <span class="n">results_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_result</span><span class="p">)</span>
            <span class="n">aggregate_steps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_extract_script_step_results</span><span class="p">(</span><span class="n">chunk_result</span><span class="p">,</span> <span class="n">worker_key</span><span class="p">))</span>

            <span class="n">chunk_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_script_chunk_status</span><span class="p">(</span><span class="n">chunk_result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chunk_status</span> <span class="o">==</span> <span class="s2">&quot;FAILED&quot;</span><span class="p">:</span>
                <span class="n">overall_status</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>
                <span class="k">break</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Executed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregate_steps</span><span class="p">)</span><span class="si">}</span><span class="s2"> scripted step(s) (</span><span class="si">{</span><span class="n">overall_status</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
                <span class="s2">&quot;overall_status&quot;</span><span class="p">:</span> <span class="n">overall_status</span><span class="p">,</span>
                <span class="s2">&quot;script_goal&quot;</span><span class="p">:</span> <span class="n">goal</span><span class="p">,</span>
                <span class="s2">&quot;script_steps&quot;</span><span class="p">:</span> <span class="n">aggregate_steps</span><span class="p">,</span>
                <span class="s2">&quot;worker_results&quot;</span><span class="p">:</span> <span class="n">results_run</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;human_readable_summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">script_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thought&quot;</span><span class="p">):</span>
            <span class="n">aggregated</span><span class="p">[</span><span class="s2">&quot;payload&quot;</span><span class="p">][</span><span class="s2">&quot;script_thought&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script_metadata</span><span class="p">[</span><span class="s2">&quot;thought&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">script_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">):</span>
            <span class="n">aggregated</span><span class="p">[</span><span class="s2">&quot;payload&quot;</span><span class="p">][</span><span class="s2">&quot;script_notes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">script_metadata</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span>

        <span class="c1"># Invoke synthesizer agent for downstream managers (if configured)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesizer_agent</span> <span class="ow">and</span> <span class="n">workers_run</span><span class="p">:</span>
            <span class="n">synthesized_output</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_synthesizer_agent</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="n">workers_run</span><span class="p">,</span>
                <span class="n">results_run</span><span class="p">,</span>
                <span class="n">strategic_plan</span><span class="p">,</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">synthesized_output</span><span class="p">:</span>
                <span class="c1"># Add phase_id metadata if available for hierarchical filtering</span>
                <span class="n">phase_index</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;orchestrator_phase_index&quot;</span><span class="p">)</span>
                <span class="n">synthesis_entry</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">SYNTHESIS</span><span class="p">,</span>
                    <span class="s2">&quot;from_manager&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">synthesized_output</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">phase_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">synthesis_entry</span><span class="p">[</span><span class="s2">&quot;phase_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_index</span>
                <span class="n">add_global_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;add_global&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">add_global_method</span><span class="p">):</span>
                    <span class="n">add_global_method</span><span class="p">(</span><span class="n">synthesis_entry</span><span class="p">)</span>
                <span class="n">synthesizer_final</span> <span class="o">=</span> <span class="n">synthesized_output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;full_result&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">synthesizer_final</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">):</span>
                    <span class="n">synthesizer_final</span> <span class="o">=</span> <span class="n">synthesizer_final</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">synthesizer_final</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">synthesizer_final</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

        <span class="n">final_result</span> <span class="o">=</span> <span class="n">aggregated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_gateway</span><span class="p">:</span>
            <span class="n">synthesized</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_result</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="n">aggregated</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synthesized</span><span class="p">:</span>
                <span class="n">final_result</span> <span class="o">=</span> <span class="n">synthesized</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">final_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_group_script_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Group consecutive script steps by worker to minimize delegations.&quot;&quot;&quot;</span>
        <span class="n">segments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">current_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;direct&quot;</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">script_steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">worker_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker_key&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker_key</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mode_hint</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;execution_mode&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;guided_reasoning&quot;</span><span class="p">)</span>
            <span class="n">normalized_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_execution_mode</span><span class="p">(</span><span class="n">mode_hint</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;direct&quot;</span>
            <span class="k">if</span> <span class="n">segments</span> <span class="ow">and</span> <span class="n">worker_key</span> <span class="o">==</span> <span class="n">current_worker</span> <span class="ow">and</span> <span class="n">normalized_mode</span> <span class="o">==</span> <span class="n">current_mode</span><span class="p">:</span>
                <span class="n">segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">worker_key</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">normalized_mode</span><span class="p">,</span> <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">step</span><span class="p">]})</span>
                <span class="n">current_worker</span> <span class="o">=</span> <span class="n">worker_key</span>
                <span class="n">current_mode</span> <span class="o">=</span> <span class="n">normalized_mode</span>
        <span class="k">return</span> <span class="n">segments</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_execution_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize execution mode hints into &#39;direct&#39; or &#39;guided&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;guided&quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="s2">&quot;direct&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lowered</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lowered</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;guided&quot;</span><span class="p">,</span> <span class="s2">&quot;guided_reasoning&quot;</span><span class="p">,</span> <span class="s2">&quot;plan&quot;</span><span class="p">,</span> <span class="s2">&quot;guided-mode&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="s2">&quot;guided&quot;</span>
            <span class="k">if</span> <span class="n">lowered</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="s2">&quot;sequential&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="s2">&quot;direct&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_script_step_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_result</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">worker_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pull normalized script step summaries out of a worker result.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script_steps&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script_steps&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">script_exec</span> <span class="o">=</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script_execution&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script_exec</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">script_exec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script_steps&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">script_exec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">)</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">rec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="n">worker_key</span><span class="p">)</span>
                <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalized</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_script_chunk_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_result</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine status for a script chunk based on worker result.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overall_status&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">worker_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overall_status&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">status</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;SUCCESS&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_script_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure each script step targets a known worker/tool and satisfies required args.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">script_steps</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Script step </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is not a valid object&quot;</span>
            <span class="n">worker_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker_key&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker_key</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Script step </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is missing a worker&quot;</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">worker</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Script step </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> references unknown worker &#39;</span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

            <span class="n">execution_mode</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;execution_mode&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">execution_mode</span> <span class="o">==</span> <span class="s2">&quot;guided&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">tool_name</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tool_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Script step </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is missing tool_name&quot;</span>

            <span class="n">tools_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tools_map</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools_map</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Script step </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> references unknown tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; for worker &#39;</span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

            <span class="n">tool</span> <span class="o">=</span> <span class="n">tools_map</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">normalize_script_args</span><span class="p">(</span><span class="n">tool_name</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="s2">&quot;args_schema&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">schema</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Script step </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">) has invalid args: &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ve</span><span class="o">.</span><span class="n">errors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">ve</span><span class="p">))</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ve</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;errors&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">ve</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract phases from strategic plan.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="c1"># Try different plan structures</span>
        <span class="c1"># Structure 1: strategic_plan = {&quot;plan&quot;: {&quot;phases&quot;: [...]}}</span>
        <span class="n">plan_obj</span> <span class="o">=</span> <span class="n">strategic_plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">plan_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">phases</span>
        
        <span class="c1"># Structure 2: strategic_plan = {&quot;phases&quot;: [...]}</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">strategic_plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">phases</span>
        
        <span class="c1"># Structure 3: strategic_plan itself is the plan object with phases</span>
        <span class="k">if</span> <span class="s2">&quot;phases&quot;</span> <span class="ow">in</span> <span class="n">strategic_plan</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">strategic_plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">phases</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_parallel_delegation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">],</span>
        <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">policy_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle parallel delegation to multiple workers.&quot;&quot;&quot;</span>
        <span class="c1"># Filter to valid Actions targeting known workers</span>
        <span class="n">valid_actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span> 
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Action</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">tool_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_actions</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
                <span class="s2">&quot;Planner returned no valid worker actions&quot;</span><span class="p">,</span>
                <span class="n">progress_handler</span>
            <span class="p">)</span>

        <span class="c1"># Ensure strategic context propagated</span>
        <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">strategic_plan</span><span class="o">=</span><span class="n">strategic_plan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">director_context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Delegate to multiple workers in parallel</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">aio</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_one</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_to_worker_parallel</span><span class="p">(</span>
                <span class="n">action</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">action</span><span class="o">.</span><span class="n">tool_args</span><span class="p">,</span>
                <span class="n">strategic_plan</span><span class="p">,</span>
                <span class="n">context</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">run_one</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">valid_actions</span><span class="p">),</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># If any worker requests approval, bubble it up immediately</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;await_approval&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">job_id</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;JOB_ID&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;job_id&quot;</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                    <span class="n">tool</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">worker_key</span> <span class="o">=</span> <span class="n">valid_actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tool_name</span> <span class="k">if</span> <span class="n">valid_actions</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">job_id</span> <span class="ow">and</span> <span class="n">tool</span> <span class="ow">and</span> <span class="n">worker_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="o">.</span><span class="n">save_pending_action</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">),</span> <span class="n">worker</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">worker_key</span><span class="p">),</span> <span class="n">tool</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tool</span><span class="p">),</span>
                            <span class="n">args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">{}),</span> <span class="n">manager</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_approval_request</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

        <span class="c1"># Aggregate results</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_parallel_manager_results</span><span class="p">(</span><span class="n">valid_actions</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="c1"># Optional synthesis</span>
        <span class="n">final_result</span> <span class="o">=</span> <span class="n">aggregated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_gateway</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">synthesized</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_synthesize_result</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="n">aggregated</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">synthesized</span><span class="p">:</span>
                    <span class="n">final_result</span> <span class="o">=</span> <span class="n">synthesized</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synthesis failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">final_result</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_delegate_to_worker_parallel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">],</span>
        <span class="n">tool_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lightweight delegation used for parallel fan-out without emitting manager_end per worker.&quot;&quot;&quot;</span>
        <span class="c1"># Extract strategic plan from tool_args if present, otherwise use parameter</span>
        <span class="n">worker_strategic_plan</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tool_args</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">worker_context</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_task&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tool_args</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">script_steps</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tool_args</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">script_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">script_steps</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">script_steps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">script_metadata</span> <span class="o">=</span> <span class="p">(</span><span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;script_metadata&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tool_args</span> <span class="k">else</span> <span class="p">{})</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">suggested_plan</span> <span class="o">=</span> <span class="n">tool_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suggested_plan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tool_args</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">suggested_plan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suggested_plan</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">suggested_plan</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Use tool_args strategic_plan if provided, otherwise fall back to parameter</span>
        <span class="k">if</span> <span class="n">worker_strategic_plan</span><span class="p">:</span>
            <span class="n">strategic_plan</span> <span class="o">=</span> <span class="n">worker_strategic_plan</span>
        <span class="c1"># If no strategic_plan in tool_args but we have it as parameter, use parameter</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="c1"># strategic_plan parameter already set, no need to override</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">worker_context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">worker_context</span> <span class="ow">or</span> <span class="n">task</span>

        <span class="c1"># Log delegation</span>
        <span class="n">delegation_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;has_strategic_plan&quot;</span><span class="p">:</span> <span class="n">worker_strategic_plan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;has_script&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">script_steps</span><span class="p">),</span>
            <span class="s2">&quot;has_guided_plan&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">suggested_plan</span><span class="p">),</span>
            <span class="s2">&quot;parallel&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">planned_event</span> <span class="o">=</span> <span class="n">build_delegation_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">worker_key</span><span class="o">=</span><span class="n">worker_key</span><span class="p">,</span>
            <span class="n">worker_agent_name</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker_key</span><span class="p">),</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">worker_key</span><span class="p">),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">delegation_metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;delegation_planned&quot;</span><span class="p">,</span> <span class="n">planned_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;delegation_planned&quot;</span><span class="p">,</span> <span class="n">planned_event</span><span class="p">)</span>

        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">worker</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Worker not found: </span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
                <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="s2">&quot;human_readable_summary&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">error_event</span> <span class="o">=</span> <span class="n">build_error_event</span><span class="p">(</span>
                <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
                <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error_event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error_event</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">err</span>

        <span class="n">worker_agent_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">worker_key</span><span class="p">)</span>
        <span class="n">chosen_event</span> <span class="o">=</span> <span class="n">build_delegation_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">worker_key</span><span class="o">=</span><span class="n">worker_key</span><span class="p">,</span>
            <span class="n">worker_agent_name</span><span class="o">=</span><span class="n">worker_agent_name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;parallel&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;delegation_chosen&quot;</span><span class="p">,</span> <span class="n">chosen_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;delegation_chosen&quot;</span><span class="p">,</span> <span class="n">chosen_event</span><span class="p">)</span>

        <span class="c1"># Dispatch based on worker type and script mode</span>
        <span class="n">worker_context_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_worker_execution_context</span><span class="p">(</span>
            <span class="n">worker_key</span><span class="o">=</span><span class="n">worker_key</span><span class="p">,</span>
            <span class="n">worker_task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
            <span class="n">director_context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">script_steps</span><span class="o">=</span><span class="n">script_steps</span><span class="p">,</span>
            <span class="n">script_metadata</span><span class="o">=</span><span class="n">script_metadata</span><span class="p">,</span>
            <span class="n">suggested_plan</span><span class="o">=</span><span class="n">suggested_plan</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">script_steps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">ManagerAgent</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot execute script steps with manager worker &#39;</span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="n">progress_handler</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">enriched_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">script_metadata</span><span class="p">)</span>
            <span class="n">enriched_metadata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;goal&quot;</span><span class="p">,</span> <span class="n">script_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goal&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">task</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="o">=</span><span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">script</span><span class="o">=</span><span class="n">script_steps</span><span class="p">,</span>
                <span class="n">script_metadata</span><span class="o">=</span><span class="n">enriched_metadata</span><span class="p">,</span>
                <span class="n">execution_context</span><span class="o">=</span><span class="n">worker_context_bundle</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">suggested_plan</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">ManagerAgent</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot provide suggested plan to manager worker &#39;</span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="n">progress_handler</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="o">=</span><span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">suggested_plan</span><span class="o">=</span><span class="n">suggested_plan</span><span class="p">,</span>
                <span class="n">script_metadata</span><span class="o">=</span><span class="n">script_metadata</span><span class="p">,</span>
                <span class="n">execution_context</span><span class="o">=</span><span class="n">worker_context_bundle</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">ManagerAgent</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="o">=</span><span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">strategic_plan</span><span class="o">=</span><span class="n">strategic_plan</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="o">=</span><span class="n">progress_handler</span><span class="p">,</span>
                <span class="n">execution_context</span><span class="o">=</span><span class="n">worker_context_bundle</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">FinalResponse</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
                <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)},</span>
                <span class="s2">&quot;human_readable_summary&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
            <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">DELEGATION</span><span class="p">,</span> <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">worker_key</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">OBSERVATION</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>
        
        <span class="c1"># Broadcast for parallel/sibling visibility</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">add_global_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="s2">&quot;add_global&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">add_global_method</span><span class="p">):</span>
                <span class="n">add_global_method</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">GLOBAL_OBSERVATION</span><span class="p">,</span>
                    <span class="s2">&quot;from_worker&quot;</span><span class="p">:</span> <span class="n">worker_key</span><span class="p">,</span>
                    <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                    <span class="s2">&quot;parallel&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">executed_event</span> <span class="o">=</span> <span class="n">build_delegation_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">worker_key</span><span class="o">=</span><span class="n">worker_key</span><span class="p">,</span>
            <span class="n">worker_agent_name</span><span class="o">=</span><span class="n">worker_agent_name</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;parallel&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;delegation_executed&quot;</span><span class="p">,</span> <span class="n">executed_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;delegation_executed&quot;</span><span class="p">,</span> <span class="n">executed_event</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_orchestrator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;orchestrator&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_describe_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">descriptions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">desc</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">descriptions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_summarize_plan_for_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract lightweight phase summaries from orchestrator or manager plans.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">plan_data</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plan&quot;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">plan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phases&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">summarized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">summarized</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker&quot;</span><span class="p">),</span>
                <span class="s2">&quot;goals&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;goals&quot;</span><span class="p">),</span>
                <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">phase</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;notes&quot;</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">summarized</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">summary</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;phases&quot;</span><span class="p">:</span> <span class="n">summarized</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;task_type&quot;</span><span class="p">,</span> <span class="s2">&quot;rationale&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_worker&quot;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">plan_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">summary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_describe_manager_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return lightweight metadata for manager tools.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">tools_out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tool</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">tools_out</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">desc</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">tools_out</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_inject_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">manifest_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context_text</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">DIRECTOR_CONTEXT</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">context_text</span><span class="p">})</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">director_context</span><span class="o">=</span><span class="n">context_text</span><span class="p">)</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context_text</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">snippet</span> <span class="o">=</span> <span class="n">context_text</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">500</span> <span class="k">else</span> <span class="n">context_text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Manager </span><span class="si">%s</span><span class="s2"> loaded director_context (</span><span class="si">%d</span><span class="s2"> chars): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">context_text</span><span class="p">),</span> <span class="n">snippet</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">manifest_text</span><span class="p">:</span>
            <span class="n">update_request_context</span><span class="p">(</span><span class="n">data_model_context</span><span class="o">=</span><span class="n">manifest_text</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">manifest_text</span><span class="p">)</span>
                <span class="n">snippet</span> <span class="o">=</span> <span class="n">manifest_text</span> <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">500</span> <span class="k">else</span> <span class="n">manifest_text</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Manager </span><span class="si">%s</span><span class="s2"> loaded data_model_context (</span><span class="si">%d</span><span class="s2"> chars) snippet: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">snippet</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_context_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ContextBuilder</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;JOB_ID&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;job_id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span> <span class="o">=</span> <span class="n">ContextBuilder</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_worker_execution_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">worker_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">worker_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">director_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">script_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">script_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">suggested_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble the just-in-time context package passed to worker agents.&quot;&quot;&quot;</span>
        <span class="n">manager_goal</span> <span class="o">=</span> <span class="n">director_context</span> <span class="ow">or</span> <span class="n">worker_task</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span><span class="p">:</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span><span class="o">.</span><span class="n">build_worker_execution_context</span><span class="p">(</span>
                <span class="n">manager_goal</span><span class="o">=</span><span class="n">manager_goal</span><span class="p">,</span>
                <span class="n">script_steps</span><span class="o">=</span><span class="n">script_steps</span><span class="p">,</span>
                <span class="n">suggested_plan</span><span class="o">=</span><span class="n">suggested_plan</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;worker_key&quot;</span><span class="p">,</span> <span class="n">worker_key</span><span class="p">)</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;script_metadata&quot;</span><span class="p">,</span> <span class="n">script_metadata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bundle</span>

        <span class="n">assembled_context</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;== Manager Goal ==&quot;</span><span class="p">,</span>
                <span class="n">manager_goal</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;== Worker Task ==&quot;</span><span class="p">,</span>
                <span class="n">worker_task</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;manager_goal&quot;</span><span class="p">:</span> <span class="n">manager_goal</span><span class="p">,</span>
            <span class="s2">&quot;worker_task&quot;</span><span class="p">:</span> <span class="n">worker_task</span><span class="p">,</span>
            <span class="s2">&quot;script_steps&quot;</span><span class="p">:</span> <span class="n">script_steps</span><span class="p">,</span>
            <span class="s2">&quot;script_metadata&quot;</span><span class="p">:</span> <span class="n">script_metadata</span><span class="p">,</span>
            <span class="s2">&quot;suggested_plan&quot;</span><span class="p">:</span> <span class="n">suggested_plan</span><span class="p">,</span>
            <span class="s2">&quot;assembled_context&quot;</span><span class="p">:</span> <span class="n">assembled_context</span><span class="p">,</span>
            <span class="s2">&quot;worker_key&quot;</span><span class="p">:</span> <span class="n">worker_key</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_parallel_manager_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">actions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span>
        <span class="n">results</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate results from multiple parallel manager delegations.&quot;&quot;&quot;</span>
        <span class="n">sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">worker_summaries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
            <span class="n">result_summary</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;worker&quot;</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
                <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">),</span>
                <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">result_summary</span><span class="p">,</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="c1"># Collect meaningful summaries from worker results (not just delegation status)</span>
            <span class="k">if</span> <span class="n">result_summary</span><span class="p">:</span>
                <span class="n">worker_summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_summary</span><span class="p">[:</span><span class="mi">200</span><span class="p">])</span>  <span class="c1"># Truncate for summary</span>
        
        <span class="c1"># Build summary from actual worker results, not delegation status</span>
        <span class="c1"># This provides meaningful context for orchestrator instead of completion-sounding language</span>
        <span class="k">if</span> <span class="n">worker_summaries</span><span class="p">:</span>
            <span class="c1"># Use actual worker summaries - more informative for conversation history</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">worker_summaries</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">worker_summaries</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="k">else</span> \
                     <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">worker_summaries</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">worker_summaries</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2"> more&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback if no summaries available</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Executed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> parallel manager delegations: &quot;</span> <span class="o">+</span> \
                     <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">tool_name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
                <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="n">sections</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;human_readable_summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize and return result.&quot;&quot;&quot;</span>
        <span class="n">end_data</span> <span class="o">=</span> <span class="n">build_manager_end_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">end_data</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;manager&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_final_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">final_response</span><span class="p">:</span> <span class="n">FinalResponse</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle FinalResponse from planner.&quot;&quot;&quot;</span>
        <span class="n">final_dict</span> <span class="o">=</span> <span class="n">final_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">add</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">FINAL</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">final_response</span><span class="o">.</span><span class="n">human_readable_summary</span><span class="p">})</span>
        
        <span class="n">end_data</span> <span class="o">=</span> <span class="n">build_manager_end_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="n">final_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">end_data</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;manager&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_dict</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create_error_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create error response.&quot;&quot;&quot;</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
            <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="s2">&quot;human_readable_summary&quot;</span><span class="p">:</span> <span class="n">message</span>
        <span class="p">}</span>
        <span class="n">error_event</span> <span class="o">=</span> <span class="n">build_error_event</span><span class="p">(</span>
            <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
            <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error_event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">error_event</span><span class="p">)</span>
        <span class="n">end_data</span> <span class="o">=</span> <span class="n">build_manager_end_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="n">error_response</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">error_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">end_data</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;manager&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error_response</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_approval_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">approval_result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle approval request from worker.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;JOB_ID&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;job_id&quot;</span><span class="p">)</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">approval_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">approval_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="n">tool</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">job_id</span> <span class="ow">and</span> <span class="n">tool</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_store</span><span class="o">.</span><span class="n">save_pending_action</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">),</span> <span class="n">worker</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="n">tool</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tool</span><span class="p">),</span>
                    <span class="n">args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">{}),</span> <span class="n">manager</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="n">end_data</span> <span class="o">=</span> <span class="n">build_manager_end_event</span><span class="p">(</span>
            <span class="n">manager_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">manager_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="n">approval_result</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">end_data</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;manager&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;manager_end&quot;</span><span class="p">,</span> <span class="n">end_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">approval_result</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_manager_tool</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">,</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a manager tool.&quot;&quot;&quot;</span>
        <span class="n">tool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">[</span><span class="n">action</span><span class="o">.</span><span class="n">tool_name</span><span class="p">]</span>
        
        <span class="n">planned_data</span> <span class="o">=</span> <span class="n">build_action_planned_event</span><span class="p">(</span>
            <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
            <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">tool_name</span><span class="o">=</span><span class="n">action</span><span class="o">.</span><span class="n">tool_name</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">action</span><span class="o">.</span><span class="n">tool_args</span><span class="p">,</span>
            <span class="n">tool_description</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;manager_tool&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;action_planned&quot;</span><span class="p">,</span> <span class="n">planned_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;action_planned&quot;</span><span class="p">,</span> <span class="n">planned_data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">aio</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">contextvars</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">aio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">contextvars</span><span class="o">.</span><span class="n">copy_context</span><span class="p">()</span>
            
            <span class="k">def</span><span class="w"> </span><span class="nf">run_tool</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">tool</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">**</span><span class="n">action</span><span class="o">.</span><span class="n">tool_args</span><span class="p">)</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">run_tool</span><span class="p">)</span>
            
            <span class="n">executed_data</span> <span class="o">=</span> <span class="n">build_action_executed_event</span><span class="p">(</span>
                <span class="n">actor_role</span><span class="o">=</span><span class="s2">&quot;manager&quot;</span><span class="p">,</span>
                <span class="n">actor_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">actor_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">tool_name</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">action</span><span class="o">.</span><span class="n">tool_args</span><span class="p">,</span>
                <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
                <span class="n">tool_label</span><span class="o">=</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;manager_tool&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;action_executed&quot;</span><span class="p">,</span> <span class="n">executed_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">progress_handler</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">progress_handler</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="s2">&quot;action_executed&quot;</span><span class="p">,</span> <span class="n">executed_data</span><span class="p">)</span>

            <span class="n">final_response</span> <span class="o">=</span> <span class="n">FinalResponse</span><span class="p">(</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;display_message&quot;</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)},</span>
                <span class="n">human_readable_summary</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Executed </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, result: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_result</span><span class="p">(</span><span class="n">final_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="n">progress_handler</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Manager tool </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_error_response</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">progress_handler</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_synthesize_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">original_task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">worker_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">worker_result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synthesize worker result with manager-level intelligence.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_gateway</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span>
        
        <span class="n">strategic_plan</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
        <span class="n">user_messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span> 
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;user_message&quot;</span>
        <span class="p">]</span>
        <span class="n">original_user_message</span> <span class="o">=</span> <span class="n">user_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">user_messages</span> <span class="k">else</span> <span class="n">original_task</span>
        
        <span class="n">result_summary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">worker_result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">2000</span><span class="p">]</span>
        <span class="n">strategic_plan_text</span> <span class="o">=</span> <span class="s2">&quot;Not provided&quot;</span>
        <span class="k">if</span> <span class="n">strategic_plan</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">strategic_plan_text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strategic_plan_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strategic_plan</span><span class="p">)[:</span><span class="mi">500</span><span class="p">]</span>
        
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_prompt</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">STRATEGIC CONTEXT:</span>
<span class="s2">==================</span>
<span class="s2">Original User Question: </span><span class="si">{</span><span class="n">original_user_message</span><span class="si">}</span>

<span class="s2">Strategic Plan from Orchestrator:</span>
<span class="si">{</span><span class="n">strategic_plan_text</span><span class="si">}</span>

<span class="s2">TASK EXECUTION:</span>
<span class="s2">===============</span>
<span class="s2">Manager Task: </span><span class="si">{</span><span class="n">original_task</span><span class="si">}</span>
<span class="s2">Delegated to Worker: </span><span class="si">{</span><span class="n">worker_key</span><span class="si">}</span>

<span class="s2">Worker Result:</span>
<span class="si">{</span><span class="n">result_summary</span><span class="si">}</span>

<span class="s2">SYNTHESIS REQUEST:</span>
<span class="s2">==================</span>
<span class="s2">Analyze this result in the context of the user&#39;s ORIGINAL question and the strategic plan.</span>

<span class="s2">Return JSON with &quot;final_response&quot; containing:</span>
<span class="se">{{</span>
<span class="s2">  &quot;final_response&quot;: </span><span class="se">{{</span>
<span class="s2">    &quot;operation&quot;: &quot;display_table|display_message|model_ops&quot;,</span>
<span class="s2">    &quot;payload&quot;: </span><span class="se">{{</span><span class="s2"> ... reorganized/enhanced data aligned with user intent ... </span><span class="se">}}</span><span class="s2">,</span>
<span class="s2">    &quot;human_readable_summary&quot;: &quot;Your context-aware synthesis with strategic insights&quot;</span>
<span class="s2">  </span><span class="se">}}</span>
<span class="se">}}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">}</span>
        <span class="p">]</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesis_gateway</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{[\s\S]*&quot;final_response&quot;[\s\S]*\}&#39;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="s2">&quot;final_response&quot;</span> <span class="ow">in</span> <span class="n">parsed</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;final_response&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_invoke_synthesizer_agent</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">workers_run</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">results_run</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">strategic_plan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">progress_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseProgressHandler</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoke synthesizer agent to create detailed summaries for next manager.</span>
<span class="sd">        </span>
<span class="sd">        This collects all worker agent outputs and uses a separate, more powerful</span>
<span class="sd">        synthesizer agent to create detailed, structured summaries that the next</span>
<span class="sd">        manager can use for planning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesizer_agent</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..services.request_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_from_context</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_context_builder</span><span class="p">()</span>

            <span class="n">orchestrator_plan</span> <span class="o">=</span> <span class="n">get_from_context</span><span class="p">(</span><span class="s2">&quot;strategic_plan&quot;</span><span class="p">)</span>
            <span class="n">latest_request</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">latest_user_message</span><span class="p">()</span> <span class="k">if</span> <span class="n">builder</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">technical_payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;manager&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;manager_task&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span>
                <span class="s2">&quot;orchestrator_plan&quot;</span><span class="p">:</span> <span class="n">orchestrator_plan</span><span class="p">,</span>
                <span class="s2">&quot;worker_results&quot;</span><span class="p">:</span> <span class="n">results_run</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">context_text</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">builder</span><span class="p">:</span>
                <span class="n">context_text</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build_synthesizer_context</span><span class="p">(</span>
                    <span class="n">latest_request</span> <span class="ow">or</span> <span class="n">task</span><span class="p">,</span>
                    <span class="n">technical_payload</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">context_text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">technical_payload</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">synthesizer_task</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are a synthesis specialist. Combine the technical outcome below into a structured summary for the next agent.</span>

<span class="si">{</span><span class="n">context_text</span><span class="si">}</span>

<span class="s2">Requirements:</span>
<span class="s2">1. Include ALL actual data from worker results (tables, IDs, SQL, DAX, payloads).</span>
<span class="s2">2. Produce structured output the next manager can ingest without re-querying data.</span>
<span class="s2">3. Highlight actionable follow-ups tied to the user&#39;s request.</span>
<span class="s2">Return JSON with summary + actual_data fields.&quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invoking synthesizer agent for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to create detailed summary for next manager&quot;</span><span class="p">)</span>
            <span class="n">synthesized_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">synthesizer_agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">synthesizer_task</span><span class="p">,</span>
                <span class="n">progress_handler</span><span class="o">=</span><span class="n">progress_handler</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">synthesized_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">synthesized_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;human_readable_summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">synthesized_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">synthesized_result</span><span class="p">)</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">synthesized_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">actual_data</span> <span class="o">=</span> <span class="n">payload</span> <span class="k">if</span> <span class="n">payload</span> <span class="k">else</span> <span class="n">synthesized_result</span>
                <span class="n">synthesis_result</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">SYNTHESIS</span><span class="p">,</span>
                    <span class="s2">&quot;from_manager&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;synthesized_summary&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">,</span>
                    <span class="s2">&quot;actual_data&quot;</span><span class="p">:</span> <span class="n">actual_data</span><span class="p">,</span>
                    <span class="s2">&quot;full_result&quot;</span><span class="p">:</span> <span class="n">synthesized_result</span><span class="p">,</span>
                    <span class="s2">&quot;worker_results&quot;</span><span class="p">:</span> <span class="n">results_run</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="c1"># Add phase_id metadata if available for hierarchical filtering</span>
                <span class="n">phase_index</span> <span class="o">=</span> <span class="n">_get_ctx</span><span class="p">(</span><span class="s2">&quot;orchestrator_phase_index&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phase_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">synthesis_result</span><span class="p">[</span><span class="s2">&quot;phase_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_index</span>
                <span class="k">return</span> <span class="n">synthesis_result</span>
            
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to invoke synthesizer agent: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Agent Framework Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>